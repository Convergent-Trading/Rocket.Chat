{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mailer/lib/Mailer.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/functions/sendMail.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/functions/unsubscribe.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/methods/sendMail.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/methods/unsubscribe.js"],"names":["Mailer","Meteor","startup","RocketChat","models","Permissions","upsert","$setOnInsert","_id","roles","Users","rocketMailUnsubscribe","createdAt","query","Date","parseInt","update","$set","affectedRows","console","log","s","module","watch","require","default","v","sendMail","from","subject","body","dryrun","rfcMailPatternWithName","test","Error","function","indexOf","header","placeholders","replace","settings","get","footer","userQuery","$exists","$and","EJSON","parse","users","find","forEach","user","email","undefined","emails","address","html","unsubscribe","absoluteUrl","FlowRouter","path","getTime","name","defer","Email","send","to","escapeHTML","methods","userId","method","authz","hasRole","DDPRateLimiter","addRule","type","connectionId"],"mappings":"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","file":"/packages/rocketchat_mailer.js","sourcesContent":["Mailer = {};//eslint-disable-line\n","Meteor.startup(function() {\n\treturn RocketChat.models.Permissions.upsert('access-mailer', {\n\t\t$setOnInsert: {\n\t\t\t_id: 'access-mailer',\n\t\t\troles: ['admin'],\n\t\t},\n\t});\n});\n","RocketChat.models.Users.rocketMailUnsubscribe = function(_id, createdAt) {\n\tconst query = {\n\t\t_id,\n\t\tcreatedAt: new Date(parseInt(createdAt)),\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\t'mailer.unsubscribed': true,\n\t\t},\n\t};\n\tconst affectedRows = this.update(query, update);\n\tconsole.log('[Mailer:Unsubscribe]', _id, createdAt, new Date(parseInt(createdAt)), affectedRows);\n\treturn affectedRows;\n};\n","/* globals Mailer */\nimport s from 'underscore.string';\n\nMailer.sendMail = function(from, subject, body, dryrun, query) {\n\n\tconst rfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;\n\tif (!rfcMailPatternWithName.test(from)) {\n\t\tthrow new Meteor.Error('error-invalid-from-address', 'Invalid from address', {\n\t\t\tfunction: 'Mailer.sendMail',\n\t\t});\n\t}\n\tif (body.indexOf('[unsubscribe]') === -1) {\n\t\tthrow new Meteor.Error('error-missing-unsubscribe-link', 'You must provide the [unsubscribe] link.', {\n\t\t\tfunction: 'Mailer.sendMail',\n\t\t});\n\t}\n\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\tlet userQuery = { 'mailer.unsubscribed': { $exists: 0 } };\n\tif (query) {\n\t\tuserQuery = { $and: [userQuery, EJSON.parse(query)] };\n\t}\n\n\tif (dryrun) {\n\t\treturn Meteor.users.find({\n\t\t\t'emails.address': from,\n\t\t}).forEach((user) => {\n\t\t\tlet email = undefined;\n\t\t\tif (user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\temail = user.emails[0].address;\n\t\t\t}\n\t\t\tconst html = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tcreatedAt: user.createdAt.getTime(),\n\t\t\t\t})),\n\t\t\t\tname: user.name,\n\t\t\t\temail,\n\t\t\t});\n\t\t\temail = `${ user.name } <${ email }>`;\n\t\t\tif (rfcMailPatternWithName.test(email)) {\n\t\t\t\tMeteor.defer(function() {\n\t\t\t\t\treturn Email.send({\n\t\t\t\t\t\tto: email,\n\t\t\t\t\t\tfrom,\n\t\t\t\t\t\tsubject,\n\t\t\t\t\t\thtml: header + html + footer,\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\treturn console.log(`Sending email to ${ email }`);\n\t\t\t}\n\t\t});\n\t} else {\n\t\treturn Meteor.users.find(userQuery).forEach(function(user) {\n\t\t\tlet email = undefined;\n\t\t\tif (user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\temail = user.emails[0].address;\n\t\t\t}\n\t\t\tconst html = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tcreatedAt: user.createdAt.getTime(),\n\t\t\t\t})),\n\t\t\t\tname: s.escapeHTML(user.name),\n\t\t\t\temail: s.escapeHTML(email),\n\t\t\t});\n\t\t\temail = `${ user.name } <${ email }>`;\n\t\t\tif (rfcMailPatternWithName.test(email)) {\n\t\t\t\tMeteor.defer(function() {\n\t\t\t\t\treturn Email.send({\n\t\t\t\t\t\tto: email,\n\t\t\t\t\t\tfrom,\n\t\t\t\t\t\tsubject,\n\t\t\t\t\t\thtml: header + html + footer,\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\treturn console.log(`Sending email to ${ email }`);\n\t\t\t}\n\t\t});\n\t}\n};\n","/* globals Mailer */\nMailer.unsubscribe = function(_id, createdAt) {\n\tif (_id && createdAt) {\n\t\treturn RocketChat.models.Users.rocketMailUnsubscribe(_id, createdAt) === 1;\n\t}\n\treturn false;\n};\n","/* globals Mailer */\nMeteor.methods({\n\t'Mailer.sendMail'(from, subject, body, dryrun, query) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'Mailer.sendMail',\n\t\t\t});\n\t\t}\n\t\tif (RocketChat.authz.hasRole(userId, 'admin') !== true) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'Mailer.sendMail',\n\t\t\t});\n\t\t}\n\t\treturn Mailer.sendMail(from, subject, body, dryrun, query);\n\t},\n});\n\n\n// Limit setting username once per minute\n// DDPRateLimiter.addRule\n//\ttype: 'method'\n//\tname: 'Mailer.sendMail'\n//\tconnectionId: -> return true\n//\t, 1, 60000\n","/* globals Mailer */\nMeteor.methods({\n\t'Mailer:unsubscribe'(_id, createdAt) {\n\t\treturn Mailer.unsubscribe(_id, createdAt);\n\t},\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'Mailer:unsubscribe',\n\tconnectionId() {\n\t\treturn true;\n\t},\n}, 1, 60000);\n"]}