{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:emoji-custom/function-isSet.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/emoji-custom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/models/EmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/publications/fullEmojiData.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/listEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/deleteEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/insertOrUpdateEmoji.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/uploadEmojiCustom.js"],"names":["isSet","fn","value","e","undefined","isSetNotNull","_","module","watch","require","default","v","Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileEmojiCustomInstance","name","absolutePath","WebApp","connectHandlers","use","bindEnvironment","req","res","params","emoji","decodeURIComponent","url","replace","isEmpty","writeHead","write","end","file","getFileWithReadStream","encodeURIComponent","setHeader","reqModifiedHeader","headers","color","initials","svg","fileUploadDate","uploadDate","toUTCString","Date","test","split","pop","length","readStream","pipe","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","EmojiCustom","models","_Base","constructor","tryEnsureIndex","aliases","extension","findOneByID","options","findOne","findByNameOrAlias","emojiName","query","$or","find","findByNameOrAliasExceptID","except","$nin","setName","update","$set","setAliases","setExtension","create","data","insert","removeByID","remove","s","publish","filter","limit","userId","ready","fields","sort","filterReg","RegExp","escapeRegExp","methods","listEmojiCustom","fetch","deleteEmojiCustom","emojiID","authz","hasPermission","method","deleteFile","Notifications","notifyLogged","emojiData","insertOrUpdateEmoji","field","nameValidation","aliasValidation","input","Boolean","without","matchingResults","alias","concat","createEmoji","newFile","previousExtension","previousName","rs","ws","createWriteStream","contentType","on","uploadEmojiCustom","binaryContent","Buffer","bufferToStream","setTimeout"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACAA,QAAQ,UAASC,EAAT,EAAa;AACpB,MAAIC,KAAJ;;AACA,MAAI;AACHA,YAAQD,IAAR;AACA,GAFD,CAEE,OAAOE,CAAP,EAAU;AACXD,YAAQE,SAAR;AACA,GAJD,SAIU;AACT,WAAOF,UAAUE,SAAjB;AACA;AACD,CATD;;AAWAC,eAAe,UAASJ,EAAT,EAAa;AAC3B,MAAIC,KAAJ;;AACA,MAAI;AACHA,YAAQD,IAAR;AACA,GAFD,CAEE,OAAOE,CAAP,EAAU;AACXD,YAAQ,IAAR;AACA,GAJD,SAIU;AACT,WAAOA,UAAU,IAAV,IAAkBA,UAAUE,SAAnC;AACA;AACD,CATD;AAWA,kC;;;;;;;;;;;ACxBA,IAAIE,CAAJ;;AAAMC,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACL,QAAEK,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAGNC,OAAOC,OAAP,CAAe,YAAW;AACzB,MAAIC,YAAY,QAAhB;;AAEA,MAAIC,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,0BAAxB,CAAJ,EAAyD;AACxDH,gBAAYC,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,0BAAxB,CAAZ;AACA;;AAED,QAAMC,kBAAkBC,eAAeL,SAAf,CAAxB;;AAEA,MAAII,mBAAmB,IAAvB,EAA6B;AAC5B,UAAM,IAAIE,KAAJ,CAAW,iCAAiCN,SAAW,GAAvD,CAAN;AACA;;AAEDO,UAAQC,GAAR,CAAa,SAASR,SAAW,2BAArB,CAAgDS,KAA5D;AAEA,MAAIC,OAAO,WAAX;;AACA,MAAIT,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,KAAyD,IAA7D,EAAmE;AAClE,QAAIF,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,EAAsDQ,IAAtD,OAAiE,EAArE,EAAyE;AACxED,aAAOT,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,CAAP;AACA;AACD;;AAED,OAAKS,iCAAL,GAAyC,IAAIR,eAAJ,CAAoB;AAC5DS,UAAM,cADsD;AAE5DC,kBAAcJ;AAF8C,GAApB,CAAzC;AAKA,SAAOK,OAAOC,eAAP,CAAuBC,GAAvB,CAA2B,gBAA3B,EAA6CnB,OAAOoB,eAAP,CAAuB,UAASC,GAAT,EAAcC;AAAG;AAAjB,IAA8B;AACxG,UAAMC,SACL;AAAEC,aAAOC,mBAAmBJ,IAAIK,GAAJ,CAAQC,OAAR,CAAgB,KAAhB,EAAuB,EAAvB,EAA2BA,OAA3B,CAAmC,OAAnC,EAA4C,EAA5C,CAAnB;AAAT,KADD;;AAGA,QAAIjC,EAAEkC,OAAF,CAAUL,OAAOC,KAAjB,CAAJ,EAA6B;AAC5BF,UAAIO,SAAJ,CAAc,GAAd;AACAP,UAAIQ,KAAJ,CAAU,WAAV;AACAR,UAAIS,GAAJ;AACA;AACA;;AAED,UAAMC,OAAOlB,kCAAkCmB,qBAAlC,CAAwDC,mBAAmBX,OAAOC,KAA1B,CAAxD,CAAb;AAEAF,QAAIa,SAAJ,CAAc,qBAAd,EAAqC,QAArC;;AAEA,QAAIH,QAAQ,IAAZ,EAAkB;AACjB;AACAV,UAAIa,SAAJ,CAAc,cAAd,EAA8B,eAA9B;AACAb,UAAIa,SAAJ,CAAc,eAAd,EAA+B,mBAA/B;AACAb,UAAIa,SAAJ,CAAc,SAAd,EAAyB,IAAzB;AACAb,UAAIa,SAAJ,CAAc,eAAd,EAA+B,+BAA/B;AAEA,YAAMC,oBAAoBf,IAAIgB,OAAJ,CAAY,mBAAZ,CAA1B;;AACA,UAAID,qBAAqB,IAAzB,EAA+B;AAC9B,YAAIA,sBAAsB,+BAA1B,EAA2D;AAC1Dd,cAAIO,SAAJ,CAAc,GAAd;AACAP,cAAIS,GAAJ;AACA;AACA;AACD;;AAED,YAAMO,QAAQ,MAAd;AACA,YAAMC,WAAW,GAAjB;AAEA,YAAMC,MAAO;2IAC4HF,KAAO;;IAE9IC,QAAU;;OAHZ;AAOAjB,UAAIQ,KAAJ,CAAUU,GAAV;AACAlB,UAAIS,GAAJ;AACA;AACA;;AAED,QAAIU,iBAAiBjD,SAArB;;AACA,QAAIwC,KAAKU,UAAL,IAAmB,IAAvB,EAA6B;AAC5BD,uBAAiBT,KAAKU,UAAL,CAAgBC,WAAhB,EAAjB;AACA;;AAED,UAAMP,oBAAoBf,IAAIgB,OAAJ,CAAY,mBAAZ,CAA1B;;AACA,QAAID,qBAAqB,IAAzB,EAA+B;AAC9B,UAAIA,sBAAsBK,cAA1B,EAA0C;AACzCnB,YAAIa,SAAJ,CAAc,eAAd,EAA+BC,iBAA/B;AACAd,YAAIO,SAAJ,CAAc,GAAd;AACAP,YAAIS,GAAJ;AACA;AACA;AACD;;AAEDT,QAAIa,SAAJ,CAAc,eAAd,EAA+B,mBAA/B;AACAb,QAAIa,SAAJ,CAAc,SAAd,EAAyB,IAAzB;;AACA,QAAIM,kBAAkB,IAAtB,EAA4B;AAC3BnB,UAAIa,SAAJ,CAAc,eAAd,EAA+BM,cAA/B;AACA,KAFD,MAEO;AACNnB,UAAIa,SAAJ,CAAc,eAAd,EAA+B,IAAIS,IAAJ,GAAWD,WAAX,EAA/B;AACA;;AACD,QAAI,SAASE,IAAT,CAActB,OAAOC,KAAP,CAAasB,KAAb,CAAmB,GAAnB,EAAwBC,GAAxB,EAAd,CAAJ,EAAkD;AACjDzB,UAAIa,SAAJ,CAAc,cAAd,EAA8B,eAA9B;AACA,KAFD,MAEO;AACNb,UAAIa,SAAJ,CAAc,cAAd,EAA8B,YAA9B;AACA;;AACDb,QAAIa,SAAJ,CAAc,gBAAd,EAAgCH,KAAKgB,MAArC;AAEAhB,SAAKiB,UAAL,CAAgBC,IAAhB,CAAqB5B,GAArB;AACA,GA5EmD,CAA7C,CAAP;AA6EA,CAxGD,E;;;;;;;;;;;ACHAnB,WAAWC,QAAX,CAAoB+C,QAApB,CAA6B,uBAA7B,EAAsD,YAAW;AAChE,OAAKC,GAAL,CAAS,0BAAT,EAAqC,QAArC,EAA+C;AAC9CC,UAAM,QADwC;AAE9CC,YAAQ,CAAC;AACRC,WAAK,QADG;AAERC,iBAAW;AAFH,KAAD,EAGL;AACFD,WAAK,YADH;AAEFC,iBAAW;AAFT,KAHK,CAFsC;AAS9CA,eAAW;AATmC,GAA/C;AAYA,OAAKJ,GAAL,CAAS,4BAAT,EAAuC,EAAvC,EAA2C;AAC1CC,UAAM,QADoC;AAE1CI,iBAAa;AACZC,WAAK,0BADO;AAEZpE,aAAO;AAFK,KAF6B;AAM1CkE,eAAW;AAN+B,GAA3C;AAQA,CArBD,E;;;;;;;;;;;ACAA,MAAMG,WAAN,SAA0BxD,WAAWyD,MAAX,CAAkBC,KAA5C,CAAkD;AACjDC,gBAAc;AACb,UAAM,cAAN;AAEA,SAAKC,cAAL,CAAoB;AAAEhD,YAAM;AAAR,KAApB;AACA,SAAKgD,cAAL,CAAoB;AAAEC,eAAS;AAAX,KAApB;AACA,SAAKD,cAAL,CAAoB;AAAEE,iBAAW;AAAb,KAApB;AACA,GAPgD,CASjD;;;AACAC,cAAYR,GAAZ,EAAiBS,OAAjB,EAA0B;AACzB,WAAO,KAAKC,OAAL,CAAaV,GAAb,EAAkBS,OAAlB,CAAP;AACA,GAZgD,CAcjD;;;AACAE,oBAAkBC,SAAlB,EAA6BH,OAA7B,EAAsC;AACrC,QAAIpD,OAAOuD,SAAX;;AAEA,QAAI,OAAOA,SAAP,KAAqB,QAAzB,EAAmC;AAClCvD,aAAOuD,UAAU3C,OAAV,CAAkB,IAAlB,EAAwB,EAAxB,CAAP;AACA;;AAED,UAAM4C,QAAQ;AACbC,WAAK,CACJ;AAAEzD;AAAF,OADI,EAEJ;AAAEiD,iBAASjD;AAAX,OAFI;AADQ,KAAd;AAOA,WAAO,KAAK0D,IAAL,CAAUF,KAAV,EAAiBJ,OAAjB,CAAP;AACA;;AAEDO,4BAA0B3D,IAA1B,EAAgC4D,MAAhC,EAAwCR,OAAxC,EAAiD;AAChD,UAAMI,QAAQ;AACbb,WAAK;AAAEkB,cAAM,CAACD,MAAD;AAAR,OADQ;AAEbH,WAAK,CACJ;AAAEzD;AAAF,OADI,EAEJ;AAAEiD,iBAASjD;AAAX,OAFI;AAFQ,KAAd;AAQA,WAAO,KAAK0D,IAAL,CAAUF,KAAV,EAAiBJ,OAAjB,CAAP;AACA,GA1CgD,CA6CjD;;;AACAU,UAAQnB,GAAR,EAAa3C,IAAb,EAAmB;AAClB,UAAM+D,SAAS;AACdC,YAAM;AACLhE;AADK;AADQ,KAAf;AAMA,WAAO,KAAK+D,MAAL,CAAY;AAAEpB;AAAF,KAAZ,EAAqBoB,MAArB,CAAP;AACA;;AAEDE,aAAWtB,GAAX,EAAgBM,OAAhB,EAAyB;AACxB,UAAMc,SAAS;AACdC,YAAM;AACLf;AADK;AADQ,KAAf;AAMA,WAAO,KAAKc,MAAL,CAAY;AAAEpB;AAAF,KAAZ,EAAqBoB,MAArB,CAAP;AACA;;AAEDG,eAAavB,GAAb,EAAkBO,SAAlB,EAA6B;AAC5B,UAAMa,SAAS;AACdC,YAAM;AACLd;AADK;AADQ,KAAf;AAMA,WAAO,KAAKa,MAAL,CAAY;AAAEpB;AAAF,KAAZ,EAAqBoB,MAArB,CAAP;AACA,GA1EgD,CA4EjD;;;AACAI,SAAOC,IAAP,EAAa;AACZ,WAAO,KAAKC,MAAL,CAAYD,IAAZ,CAAP;AACA,GA/EgD,CAkFjD;;;AACAE,aAAW3B,GAAX,EAAgB;AACf,WAAO,KAAK4B,MAAL,CAAY5B,GAAZ,CAAP;AACA;;AArFgD;;AAwFlDvD,WAAWyD,MAAX,CAAkBD,WAAlB,GAAgC,IAAIA,WAAJ,EAAhC,C;;;;;;;;;;;ACxFA,IAAI4B,CAAJ;AAAM5F,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACC,UAAQC,CAAR,EAAU;AAACwF,QAAExF,CAAF;AAAI;;AAAhB,CAA1C,EAA4D,CAA5D;AAENC,OAAOwF,OAAP,CAAe,eAAf,EAAgC,UAASC,MAAT,EAAiBC,KAAjB,EAAwB;AACvD,MAAI,CAAC,KAAKC,MAAV,EAAkB;AACjB,WAAO,KAAKC,KAAL,EAAP;AACA;;AAED,QAAMC,SAAS;AACd9E,UAAM,CADQ;AAEdiD,aAAS,CAFK;AAGdC,eAAW;AAHG,GAAf;AAMAwB,WAASF,EAAE1E,IAAF,CAAO4E,MAAP,CAAT;AAEA,QAAMtB,UAAU;AACf0B,UADe;AAEfH,SAFe;AAGfI,UAAM;AAAE/E,YAAM;AAAR;AAHS,GAAhB;;AAMA,MAAI0E,MAAJ,EAAY;AACX,UAAMM,YAAY,IAAIC,MAAJ,CAAWT,EAAEU,YAAF,CAAeR,MAAf,CAAX,EAAmC,GAAnC,CAAlB;AACA,WAAOtF,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8BU,iBAA9B,CAAgD0B,SAAhD,EAA2D5B,OAA3D,CAAP;AACA;;AAED,SAAOhE,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8Bc,IAA9B,CAAmC,EAAnC,EAAuCN,OAAvC,CAAP;AACA,CAzBD,E;;;;;;;;;;;ACFAnE,OAAOkG,OAAP,CAAe;AACdC,oBAAkB;AACjB,WAAOhG,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8Bc,IAA9B,CAAmC,EAAnC,EAAuC2B,KAAvC,EAAP;AACA;;AAHa,CAAf,E;;;;;;;;;;;ACAA;AACApG,OAAOkG,OAAP,CAAe;AACdG,oBAAkBC,OAAlB,EAA2B;AAC1B,QAAI9E,QAAQ,IAAZ;;AAEA,QAAIrB,WAAWoG,KAAX,CAAiBC,aAAjB,CAA+B,KAAKb,MAApC,EAA4C,cAA5C,CAAJ,EAAiE;AAChEnE,cAAQrB,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8BO,WAA9B,CAA0CoC,OAA1C,CAAR;AACA,KAFD,MAEO;AACN,YAAM,IAAItG,OAAOQ,KAAX,CAAiB,gBAAjB,CAAN;AACA;;AAED,QAAIgB,SAAS,IAAb,EAAmB;AAClB,YAAM,IAAIxB,OAAOQ,KAAX,CAAiB,kCAAjB,EAAqD,eAArD,EAAsE;AAAEiG,gBAAQ;AAAV,OAAtE,CAAN;AACA;;AAED3F,sCAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAGV,MAAMT,IAAM,IAAIS,MAAMyC,SAAW,EAAxD,CAA7C;AACA9D,eAAWyD,MAAX,CAAkBD,WAAlB,CAA8B0B,UAA9B,CAAyCiB,OAAzC;AACAnG,eAAWwG,aAAX,CAAyBC,YAAzB,CAAsC,mBAAtC,EAA2D;AAAEC,iBAAWrF;AAAb,KAA3D;AAEA,WAAO,IAAP;AACA;;AAnBa,CAAf,E;;;;;;;;;;;ACDA,IAAI9B,CAAJ;;AAAMC,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACL,QAAEK,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIwF,CAAJ;AAAM5F,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACC,UAAQC,CAAR,EAAU;AAACwF,QAAExF,CAAF;AAAI;;AAAhB,CAA1C,EAA4D,CAA5D;AAIpEC,OAAOkG,OAAP,CAAe;AACdY,sBAAoBD,SAApB,EAA+B;AAC9B,QAAI,CAAC1G,WAAWoG,KAAX,CAAiBC,aAAjB,CAA+B,KAAKb,MAApC,EAA4C,cAA5C,CAAL,EAAkE;AACjE,YAAM,IAAI3F,OAAOQ,KAAX,CAAiB,gBAAjB,CAAN;AACA;;AAED,QAAI,CAAC+E,EAAE1E,IAAF,CAAOgG,UAAU9F,IAAjB,CAAL,EAA6B;AAC5B,YAAM,IAAIf,OAAOQ,KAAX,CAAiB,6BAAjB,EAAgD,4BAAhD,EAA8E;AAAEiG,gBAAQ,qBAAV;AAAiCM,eAAO;AAAxC,OAA9E,CAAN;AACA,KAP6B,CAS9B;AACA;;;AACA,UAAMC,iBAAiB,qBAAvB;AACA,UAAMC,kBAAkB,oBAAxB,CAZ8B,CAc9B;;AACAJ,cAAU9F,IAAV,GAAiB8F,UAAU9F,IAAV,CAAeY,OAAf,CAAuB,IAAvB,EAA6B,EAA7B,CAAjB;AACAkF,cAAU7C,OAAV,GAAoB6C,UAAU7C,OAAV,CAAkBrC,OAAlB,CAA0B,IAA1B,EAAgC,EAAhC,CAApB;;AAEA,QAAIqF,eAAenE,IAAf,CAAoBgE,UAAU9F,IAA9B,CAAJ,EAAyC;AACxC,YAAM,IAAIf,OAAOQ,KAAX,CAAiB,kCAAjB,EAAsD,GAAGqG,UAAU9F,IAAM,sBAAzE,EAAgG;AAAE0F,gBAAQ,qBAAV;AAAiCS,eAAOL,UAAU9F,IAAlD;AAAwDgG,eAAO;AAA/D,OAAhG,CAAN;AACA;;AAED,QAAIF,UAAU7C,OAAd,EAAuB;AACtB,UAAIiD,gBAAgBpE,IAAhB,CAAqBgE,UAAU7C,OAA/B,CAAJ,EAA6C;AAC5C,cAAM,IAAIhE,OAAOQ,KAAX,CAAiB,kCAAjB,EAAsD,GAAGqG,UAAU7C,OAAS,2BAA5E,EAAwG;AAAEyC,kBAAQ,qBAAV;AAAiCS,iBAAOL,UAAU7C,OAAlD;AAA2D+C,iBAAO;AAAlE,SAAxG,CAAN;AACA;;AACDF,gBAAU7C,OAAV,GAAoB6C,UAAU7C,OAAV,CAAkBlB,KAAlB,CAAwB,OAAxB,CAApB;AACA+D,gBAAU7C,OAAV,GAAoB6C,UAAU7C,OAAV,CAAkByB,MAAlB,CAAyB0B,OAAzB,CAApB;AACAN,gBAAU7C,OAAV,GAAoBtE,EAAE0H,OAAF,CAAUP,UAAU7C,OAApB,EAA6B6C,UAAU9F,IAAvC,CAApB;AACA,KAPD,MAOO;AACN8F,gBAAU7C,OAAV,GAAoB,EAApB;AACA;;AAED,QAAIqD,kBAAkB,EAAtB;;AAEA,QAAIR,UAAUnD,GAAd,EAAmB;AAClB2D,wBAAkBlH,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8Be,yBAA9B,CAAwDmC,UAAU9F,IAAlE,EAAwE8F,UAAUnD,GAAlF,EAAuF0C,KAAvF,EAAlB;;AACA,WAAK,MAAMkB,KAAX,IAAoBT,UAAU7C,OAA9B,EAAuC;AACtCqD,0BAAkBA,gBAAgBE,MAAhB,CAAuBpH,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8Be,yBAA9B,CAAwD4C,KAAxD,EAA+DT,UAAUnD,GAAzE,EAA8E0C,KAA9E,EAAvB,CAAlB;AACA;AACD,KALD,MAKO;AACNiB,wBAAkBlH,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8BU,iBAA9B,CAAgDwC,UAAU9F,IAA1D,EAAgEqF,KAAhE,EAAlB;;AACA,WAAK,MAAMkB,KAAX,IAAoBT,UAAU7C,OAA9B,EAAuC;AACtCqD,0BAAkBA,gBAAgBE,MAAhB,CAAuBpH,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8BU,iBAA9B,CAAgDiD,KAAhD,EAAuDlB,KAAvD,EAAvB,CAAlB;AACA;AACD;;AAED,QAAIiB,gBAAgBrE,MAAhB,GAAyB,CAA7B,EAAgC;AAC/B,YAAM,IAAIhD,OAAOQ,KAAX,CAAiB,iDAAjB,EAAoE,0DAApE,EAAgI;AAAEiG,gBAAQ;AAAV,OAAhI,CAAN;AACA;;AAED,QAAI,CAACI,UAAUnD,GAAf,EAAoB;AACnB;AACA,YAAM8D,cAAc;AACnBzG,cAAM8F,UAAU9F,IADG;AAEnBiD,iBAAS6C,UAAU7C,OAFA;AAGnBC,mBAAW4C,UAAU5C;AAHF,OAApB;;AAMA,YAAMP,MAAMvD,WAAWyD,MAAX,CAAkBD,WAAlB,CAA8BuB,MAA9B,CAAqCsC,WAArC,CAAZ;;AAEArH,iBAAWwG,aAAX,CAAyBC,YAAzB,CAAsC,mBAAtC,EAA2D;AAAEC,mBAAWW;AAAb,OAA3D;AAEA,aAAO9D,GAAP;AACA,KAbD,MAaO;AACN;AACA,UAAImD,UAAUY,OAAd,EAAuB;AACtB3G,0CAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAU9F,IAAM,IAAI8F,UAAU5C,SAAW,EAAhE,CAA7C;AACAnD,0CAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAU9F,IAAM,IAAI8F,UAAUa,iBAAmB,EAAxE,CAA7C;AACA5G,0CAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAUc,YAAc,IAAId,UAAU5C,SAAW,EAAxE,CAA7C;AACAnD,0CAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAUc,YAAc,IAAId,UAAUa,iBAAmB,EAAhF,CAA7C;AAEAvH,mBAAWyD,MAAX,CAAkBD,WAAlB,CAA8BsB,YAA9B,CAA2C4B,UAAUnD,GAArD,EAA0DmD,UAAU5C,SAApE;AACA,OAPD,MAOO,IAAI4C,UAAU9F,IAAV,KAAmB8F,UAAUc,YAAjC,EAA+C;AACrD,cAAMC,KAAK9G,kCAAkCmB,qBAAlC,CAAwDC,mBAAoB,GAAG2E,UAAUc,YAAc,IAAId,UAAUa,iBAAmB,EAAhF,CAAxD,CAAX;;AACA,YAAIE,OAAO,IAAX,EAAiB;AAChB9G,4CAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAU9F,IAAM,IAAI8F,UAAU5C,SAAW,EAAhE,CAA7C;AACA,gBAAM4D,KAAK/G,kCAAkCgH,iBAAlC,CAAoD5F,mBAAoB,GAAG2E,UAAU9F,IAAM,IAAI8F,UAAUa,iBAAmB,EAAxE,CAApD,EAAgIE,GAAGG,WAAnI,CAAX;AACAF,aAAGG,EAAH,CAAM,KAAN,EAAahI,OAAOoB,eAAP,CAAuB,MACnCN,kCAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAUc,YAAc,IAAId,UAAUa,iBAAmB,EAAhF,CAA7C,CADY,CAAb;AAGAE,aAAG3E,UAAH,CAAcC,IAAd,CAAmB2E,EAAnB;AACA;AACD;;AAED,UAAIhB,UAAU9F,IAAV,KAAmB8F,UAAUc,YAAjC,EAA+C;AAC9CxH,mBAAWyD,MAAX,CAAkBD,WAAlB,CAA8BkB,OAA9B,CAAsCgC,UAAUnD,GAAhD,EAAqDmD,UAAU9F,IAA/D;AACA;;AAED,UAAI8F,UAAU7C,OAAd,EAAuB;AACtB7D,mBAAWyD,MAAX,CAAkBD,WAAlB,CAA8BqB,UAA9B,CAAyC6B,UAAUnD,GAAnD,EAAwDmD,UAAU7C,OAAlE;AACA,OAFD,MAEO;AACN7D,mBAAWyD,MAAX,CAAkBD,WAAlB,CAA8BqB,UAA9B,CAAyC6B,UAAUnD,GAAnD,EAAwD,EAAxD;AACA;;AAEDvD,iBAAWwG,aAAX,CAAyBC,YAAzB,CAAsC,mBAAtC,EAA2D;AAAEC;AAAF,OAA3D;AAEA,aAAO,IAAP;AACA;AACD;;AApGa,CAAf,E;;;;;;;;;;;ACJA;AACA7G,OAAOkG,OAAP,CAAe;AACd+B,oBAAkBC,aAAlB,EAAiCH,WAAjC,EAA8ClB,SAA9C,EAAyD;AACxD,QAAI,CAAC1G,WAAWoG,KAAX,CAAiBC,aAAjB,CAA+B,KAAKb,MAApC,EAA4C,cAA5C,CAAL,EAAkE;AACjE,YAAM,IAAI3F,OAAOQ,KAAX,CAAiB,gBAAjB,CAAN;AACA,KAHuD,CAKxD;;;AACA,WAAOqG,UAAU7C,OAAjB;AACA,UAAMhC,OAAO,IAAImG,MAAJ,CAAWD,aAAX,EAA0B,QAA1B,CAAb;AAEA,UAAMN,KAAKrH,eAAe6H,cAAf,CAA8BpG,IAA9B,CAAX;AACAlB,sCAAkC4F,UAAlC,CAA6CxE,mBAAoB,GAAG2E,UAAU9F,IAAM,IAAI8F,UAAU5C,SAAW,EAAhE,CAA7C;AACA,UAAM4D,KAAK/G,kCAAkCgH,iBAAlC,CAAoD5F,mBAAoB,GAAG2E,UAAU9F,IAAM,IAAI8F,UAAU5C,SAAW,EAAhE,CAApD,EAAwH8D,WAAxH,CAAX;AACAF,OAAGG,EAAH,CAAM,KAAN,EAAahI,OAAOoB,eAAP,CAAuB,MACnCpB,OAAOqI,UAAP,CAAkB,MAAMlI,WAAWwG,aAAX,CAAyBC,YAAzB,CAAsC,mBAAtC,EAA2D;AAAEC;AAAF,KAA3D,CAAxB,EAAmG,GAAnG,CADY,CAAb;AAIAe,OAAG1E,IAAH,CAAQ2E,EAAR;AACA;;AAlBa,CAAf,E","file":"/packages/rocketchat_emoji-custom.js","sourcesContent":["/* globals isSet:true, isSetNotNull:true */\n// http://stackoverflow.com/a/26990347 function isSet() from Gajus\nisSet = function(fn) {\n\tlet value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = undefined;\n\t} finally {\n\t\treturn value !== undefined;\n\t}\n};\n\nisSetNotNull = function(fn) {\n\tlet value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = null;\n\t} finally {\n\t\treturn value !== null && value !== undefined;\n\t}\n};\n\n/* exported isSet, isSetNotNull */\n","/* globals RocketChatFileEmojiCustomInstance */\nimport _ from 'underscore';\n\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('EmojiUpload_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('EmojiUpload_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${ storeType }]`);\n\t}\n\n\tconsole.log(`Using ${ storeType } for custom emoji storage`.green);\n\n\tlet path = '~/uploads';\n\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath') != null) {\n\t\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('EmojiUpload_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileEmojiCustomInstance = new RocketChatStore({\n\t\tname: 'custom_emoji',\n\t\tabsolutePath: path,\n\t});\n\n\treturn WebApp.connectHandlers.use('/emoji-custom/', Meteor.bindEnvironment(function(req, res/* , next*/) {\n\t\tconst params =\n\t\t\t{ emoji: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')) };\n\n\t\tif (_.isEmpty(params.emoji)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(params.emoji));\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tif (file == null) {\n\t\t\t// use code from username initials renderer until file upload is complete\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\t\tres.setHeader('Expires', '-1');\n\t\t\tres.setHeader('Last-Modified', 'Thu, 01 Jan 2015 00:00:00 GMT');\n\n\t\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\t\tif (reqModifiedHeader != null) {\n\t\t\t\tif (reqModifiedHeader === 'Thu, 01 Jan 2015 00:00:00 GMT') {\n\t\t\t\t\tres.writeHead(304);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst color = '#000';\n\t\t\tconst initials = '?';\n\n\t\t\tconst svg = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: ${ color };\">\n\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n\t\t${ initials }\n\t</text>\n</svg>`;\n\n\t\t\tres.write(svg);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (file.uploadDate != null) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader != null) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (fileUploadDate != null) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tif (/^svg$/i.test(params.emoji.split('.').pop())) {\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t} else {\n\t\t\tres.setHeader('Content-Type', 'image/jpeg');\n\t\t}\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","RocketChat.settings.addGroup('EmojiCustomFilesystem', function() {\n\tthis.add('EmojiUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS',\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem',\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type',\n\t});\n\n\tthis.add('EmojiUpload_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'EmojiUpload_Storage_Type',\n\t\t\tvalue: 'FileSystem',\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath',\n\t});\n});\n","class EmojiCustom extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_emoji');\n\n\t\tthis.tryEnsureIndex({ name: 1 });\n\t\tthis.tryEnsureIndex({ aliases: 1 });\n\t\tthis.tryEnsureIndex({ extension: 1 });\n\t}\n\n\t// find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t// find\n\tfindByNameOrAlias(emojiName, options) {\n\t\tlet name = emojiName;\n\n\t\tif (typeof emojiName === 'string') {\n\t\t\tname = emojiName.replace(/:/g, '');\n\t\t}\n\n\t\tconst query = {\n\t\t\t$or: [\n\t\t\t\t{ name },\n\t\t\t\t{ aliases: name },\n\t\t\t],\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameOrAliasExceptID(name, except, options) {\n\t\tconst query = {\n\t\t\t_id: { $nin: [except] },\n\t\t\t$or: [\n\t\t\t\t{ name },\n\t\t\t\t{ aliases: name },\n\t\t\t],\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\n\t// update\n\tsetName(_id, name) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tname,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsetAliases(_id, aliases) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\taliases,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsetExtension(_id, extension) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\textension,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.EmojiCustom = new EmojiCustom();\n","import s from 'underscore.string';\n\nMeteor.publish('fullEmojiData', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tconst fields = {\n\t\tname: 1,\n\t\taliases: 1,\n\t\textension: 1,\n\t};\n\n\tfilter = s.trim(filter);\n\n\tconst options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 },\n\t};\n\n\tif (filter) {\n\t\tconst filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.EmojiCustom.findByNameOrAlias(filterReg, options);\n\t}\n\n\treturn RocketChat.models.EmojiCustom.find({}, options);\n});\n","Meteor.methods({\n\tlistEmojiCustom() {\n\t\treturn RocketChat.models.EmojiCustom.find({}).fetch();\n\t},\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tdeleteEmojiCustom(emojiID) {\n\t\tlet emoji = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\temoji = RocketChat.models.EmojiCustom.findOneByID(emojiID);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (emoji == null) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Invalid_Emoji', 'Invalid emoji', { method: 'deleteEmojiCustom' });\n\t\t}\n\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emoji.name }.${ emoji.extension }`));\n\t\tRocketChat.models.EmojiCustom.removeByID(emojiID);\n\t\tRocketChat.Notifications.notifyLogged('deleteEmojiCustom', { emojiData: emoji });\n\n\t\treturn true;\n\t},\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nMeteor.methods({\n\tinsertOrUpdateEmoji(emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateEmoji', field: 'Name' });\n\t\t}\n\n\t\t// allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t// more practical than allowing specific sets of characters; also allows foreign languages\n\t\tconst nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\t\tconst aliasValidation = /[:><&\\|\"'\\/\\\\\\(\\)]/;\n\n\t\t// silently strip colon; this allows for uploading :emojiname: as emojiname\n\t\temojiData.name = emojiData.name.replace(/:/g, '');\n\t\temojiData.aliases = emojiData.aliases.replace(/:/g, '');\n\n\t\tif (nameValidation.test(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ emojiData.name } is not a valid name`, { method: 'insertOrUpdateEmoji', input: emojiData.name, field: 'Name' });\n\t\t}\n\n\t\tif (emojiData.aliases) {\n\t\t\tif (aliasValidation.test(emojiData.aliases)) {\n\t\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ emojiData.aliases } is not a valid alias set`, { method: 'insertOrUpdateEmoji', input: emojiData.aliases, field: 'Alias_Set' });\n\t\t\t}\n\t\t\temojiData.aliases = emojiData.aliases.split(/[\\s,]/);\n\t\t\temojiData.aliases = emojiData.aliases.filter(Boolean);\n\t\t\temojiData.aliases = _.without(emojiData.aliases, emojiData.name);\n\t\t} else {\n\t\t\temojiData.aliases = [];\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (emojiData._id) {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(emojiData.name, emojiData._id).fetch();\n\t\t\tfor (const alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(alias, emojiData._id).fetch());\n\t\t\t}\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAlias(emojiData.name).fetch();\n\t\t\tfor (const alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAlias(alias).fetch());\n\t\t\t}\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Name_Or_Alias_Already_In_Use', 'The custom emoji or one of its aliases is already in use', { method: 'insertOrUpdateEmoji' });\n\t\t}\n\n\t\tif (!emojiData._id) {\n\t\t\t// insert emoji\n\t\t\tconst createEmoji = {\n\t\t\t\tname: emojiData.name,\n\t\t\t\taliases: emojiData.aliases,\n\t\t\t\textension: emojiData.extension,\n\t\t\t};\n\n\t\t\tconst _id = RocketChat.models.EmojiCustom.create(createEmoji);\n\n\t\t\tRocketChat.Notifications.notifyLogged('updateEmojiCustom', { emojiData: createEmoji });\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t// update emoji\n\t\t\tif (emojiData.newFile) {\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.previousExtension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.extension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`));\n\n\t\t\t\tRocketChat.models.EmojiCustom.setExtension(emojiData._id, emojiData.extension);\n\t\t\t} else if (emojiData.name !== emojiData.previousName) {\n\t\t\t\tconst rs = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`));\n\t\t\t\tif (rs !== null) {\n\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\t\t\t\tconst ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${ emojiData.name }.${ emojiData.previousExtension }`), rs.contentType);\n\t\t\t\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`))\n\t\t\t\t\t));\n\t\t\t\t\trs.readStream.pipe(ws);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (emojiData.name !== emojiData.previousName) {\n\t\t\t\tRocketChat.models.EmojiCustom.setName(emojiData._id, emojiData.name);\n\t\t\t}\n\n\t\t\tif (emojiData.aliases) {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, emojiData.aliases);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, []);\n\t\t\t}\n\n\t\t\tRocketChat.Notifications.notifyLogged('updateEmojiCustom', { emojiData });\n\n\t\t\treturn true;\n\t\t}\n\t},\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tuploadEmojiCustom(binaryContent, contentType, emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\t// delete aliases for notification purposes. here, it is a string rather than an array\n\t\tdelete emojiData.aliases;\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\tconst ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`), contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyLogged('updateEmojiCustom', { emojiData }), 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t},\n});\n"]}