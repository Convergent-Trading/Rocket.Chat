{"version":3,"sources":["meteor://ğŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/visitorStatus.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/roomType.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/leadCapture.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/RDStation.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/hooks/sendToFacebook.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/facebook.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/getNextAgent.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/loadHistory.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/removeRoom.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/sendFileLivechatMessage.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/setDepartmentForVisitor.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/startFileUploadRoom.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/Messages.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/models/LivechatVisitors.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/lib/OmniChannel.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ğŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ğŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ğŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ğŸ’»app/packages/rocketchat:livechat/config.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/LivechatRoomType.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/facebook.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/messages.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/upload.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js","meteor://ğŸ’»app/packages/rocketchat:livechat/imports/server/rest/visitors.js"],"names":["_","module","watch","require","default","v","url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","baseUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","test","html","autoupdateVersion","JSON","stringify","write","end","startup","roomTypes","setRoomFind","_id","models","Rooms","findLivechatById","fetch","authz","addRoomAccessValidator","room","user","t","hasPermission","extraData","rid","findOneById","visitorToken","token","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","UserPresenceEvents","on","session","status","metadata","visitor","LivechatInquiry","updateVisitorStatus","LivechatRoomType","LivechatVisitors","LivechatRoomTypeServer","getMsgSender","senderId","getNotificationDetails","notificationMessage","title","roomName","text","canAccessUploadedFile","rc_token","rc_rid","findOneOpenByVisitorToken","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","defer","response","HTTP","post","data","query","msg","lang","sessionId","Authorization","code","result","fulfillment","speech","LivechatExternalMessage","insert","orig","ts","Date","e","SystemLogger","error","validateMessage","phoneRegexp","RegExp","msgPhones","match","emailRegexp","msgEmails","saveGuestEmailPhoneById","run","waitingResponse","now","setResponseByRoomId","u","username","responseDate","responseTime","getTime","postData","type","sentAt","name","email","Livechat","sendRequest","MEDIUM","sendToRDStation","livechatData","getLivechatRoomGuestInfo","options","token_rdstation","identificador","client_id","nome","phone","telefone","tags","Object","keys","customFields","forEach","field","call","console","msgNavType","sendMessageType","msgType","sendNavHistory","sendToCRM","includeMessages","messages","Messages","findVisibleByRoomId","sort","Array","agentId","navigation","push","saveCRMDataByRoomId","open","OmniChannel","facebook","reply","page","id","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","roomId","getVisitorByToken","closeRoom","comment","subscription","Subscriptions","findOneByRoomIdAndUserId","action","enabled","hasToken","enable","success","updateById","disable","listPages","subscribe","unsubscribe","LivechatCustomField","find","check","String","servedBy","getAgentInfo","departmentId","info","color","registrationForm","triggers","departments","allowSwitchingDepartments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","fileUpload","conversationFinishedMessage","nameFieldRegistrationForm","emailFieldRegistrationForm","fields","cl","usernames","findOpenByVisitorTokenAndDepartmentId","findOpenByVisitorToken","length","visitorEmails","department","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","Livechat_fileupload_enabled","FileUpload_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","Livechat_conversation_finished_message","Livechat_name_field_registration_form","Livechat_email_field_registration_form","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","Livechat_allow_switching_departments","findOnlineAgents","count","requireDeparment","getRequiredDepartment","agent","getNextAgent","limit","ls","loadMessageHistory","pageInfo","savePageHistory","registerGuest","keepHistoryForToken","cursor","saveRoomInfo","customField","scope","overwrite","updateLivechatDataByToken","removeAgent","removeById","removeDepartment","removeManager","triggerId","removeByRoomId","validSettings","valid","every","setting","indexOf","customFieldData","Match","ObjectIncluding","label","visibility","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","topic","ret","saveGuest","s","values","Livechat_webhookUrl","Livechat_secret_token","Livechat_webhook_on_close","Livechat_webhook_on_offline_msg","Livechat_webhook_on_visitor_message","Livechat_webhook_on_agent_message","visitorRoom","formData","undefined","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","conditions","actions","isString","findOneByUsername","sendMessageLivechat","attachments","guest","sendMessage","file","msgData","avatar","emoji","alias","groupable","fileUrl","encodeURI","attachment","title_link","title_link_download","image_url","image_type","image_size","size","identify","image_dimensions","image_preview","FileUpload","resizeImagePreview","audio_url","audio_type","audio_size","video_url","video_type","video_size","assign","Random","dns","header","placeholders","replace","footer","fromEmail","emailDomain","substr","lastIndexOf","wrapAsync","resolveMx","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","transferData","transfer","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","hasRole","postCatchError","resolve","err","unblock","sampleData","createdAt","lastMessageAt","productId","ip","browser","os","customerId","log","statusCode","inquiryId","inquiry","subscriptionData","alert","unread","userMentions","groupMentions","desktopNotifications","mobilePushNotifications","emailNotifications","incUsersCountById","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","returnRoomAsInquiry","day","start","finish","LivechatOfficeHour","updateHours","moment","userLanguage","findVisibleByRoomIdNotContainingTypes","author","datetime","locale","format","singleMessage","emailSettings","setOperator","operator","update","$set","$exists","$ne","roles","findOneOnlineAgentByUsername","findOne","findAgents","findOnlineUserFromList","userList","$in","concat","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","closeOffice","self","openOffice","emails","surveyFeedback","findLivechat","filter","offset","extend","updateLivechatRoomCount","settingsRaw","Settings","findByVisitorToken","findByVisitorId","visitorId","responseBy","$unset","closeByRoomId","closeInfo","closer","closedBy","closedAt","chatDuration","findOpenByAgent","newAgent","changeDepartmentIdByRoomId","crmData","removeAgentByRoomId","expireAt","multi","setRoomIdByToken","_Base","constructor","isClient","_initModel","findByRoomId","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","showOnRegistration","agents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","parseInt","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","replaceUsernameOfAgentByUserId","LivechatPageVisited","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","findByToken","removeAll","findById","openInquiry","openInquiryWithAgents","agentIds","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","findVisitorByToken","findOneVisitorByPhone","getNextVisitorUsername","saveGuestById","setData","unsetData","address","phoneNumber","findOneGuestByEmailAddress","emailAddress","escapeRegExp","phones","$addToSet","saveEmail","$each","savePhone","exportDefault","UAParser","historyMonitorType","logger","Logger","sections","webhook","i","queryString","Accept","getAgents","getOnlineAgents","onlineRequired","dept","onlineAgents","roomInfo","newRoom","routingMethod","QueueMethods","showConnecting","updateUser","existingUser","userData","connection","userAgent","httpHeaders","clientAddress","number","setDepartmentForGuest","closeData","hideByRoomIdAndUserId","findNotHiddenPublic","setTopicAndTagsById","setFnameById","updateDisplayNameByRoomId","closeOpenChats","forwardOpenChats","change","pageTitle","pageUrl","location","href","_hidden","createNavigationHistoryWithRoomIdMessageAndUser","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","openInq","callback","trying","warn","setTimeout","ua","setUA","fname","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Streamer","allowRead","msgs","usersCount","setInterval","gatewayURL","authorization","pageId","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","users","queue","clearTimeout","exists","runAgentLeaveAction","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","$gte","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","findByRoomIdAndType","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","history","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","addGroup","group","public","editor","allowedTypes","section","i18nDescription","enableQuery","export","RoomSettingsEnum","RoomTypeConfig","RoomTypeRouteConfig","UiTextContext","LivechatRoomRoute","path","openRoom","link","sub","identifier","route","notSubscribedTpl","template","findRoom","ChatRoom","condition","hasAllPermission","canSendMessage","getUserStatus","Session","allowRoomSettingChange","JOIN_CODE","getUiText","context","HIDE_WARNING","LEAVE_WARNING","API","v1","addRoute","authRequired","unauthorized","bodyParams","failure","urlParams","put","delete","crypto","request","signature","createHmac","body","digest","mid","rooms","first_name","last_name","sucess","sentMessages","sentMessage","service","media","curr","message_link","contentType","extra","fromCountry","fromState","fromCity","Busboy","filesize","maxFileSize","packageValue","busboy","files","fieldname","filename","encoding","mimetype","fileDate","fileBuffer","Buffer","pipe","fileUploadIsValidContentType","reason","sizeAllowed","fileStore","getStore","details","uploadedFile","bind","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport _ from 'underscore';\nimport url from 'url';\n\nconst { WebApp } = Package.webapp;\nconst { Autoupdate } = Package.autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tlet domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${ referer.protocol }//${ referer.host }`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tlet baseUrl;\n\tif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX && __meteor_runtime_config__.ROOT_URL_PATH_PREFIX.trim() !== '') {\n\t\tbaseUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\t} else {\n\t\tbaseUrl = '/';\n\t}\n\tif (/\\/$/.test(baseUrl) === false) {\n\t\tbaseUrl += '/';\n\t}\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"${ baseUrl }livechat/livechat.css?_dc=${ Autoupdate.autoupdateVersion }\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${ JSON.stringify(__meteor_runtime_config__) };\n\t\t\t</script>\n\n\t\t\t<base href=\"${ baseUrl }\">\n\n\t\t\t${ head }\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"${ baseUrl }livechat/livechat.js?_dc=${ Autoupdate.autoupdateVersion }\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (_id) => RocketChat.models.Rooms.findLivechatById(_id).fetch());\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room && room.t === 'l' && user && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user, extraData) {\n\t\tif (!room && extraData && extraData.rid) {\n\t\t\troom = RocketChat.models.Rooms.findOneById(extraData.rid);\n\t\t}\n\t\treturn room && room.t === 'l' && extraData && extraData.visitorToken && room.v && room.v.token === extraData.visitorToken;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en',\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals UserPresenceEvents */\nMeteor.startup(() => {\n\tUserPresenceEvents.on('setStatus', (session, status, metadata) => {\n\t\tif (metadata && metadata.visitor) {\n\t\t\tRocketChat.models.LivechatInquiry.updateVisitorStatus(metadata.visitor, status);\n\t\t\tRocketChat.models.Rooms.updateVisitorStatus(metadata.visitor, status);\n\t\t}\n\t});\n});\n","import LivechatRoomType from '../imports/LivechatRoomType';\nimport LivechatVisitors from './models/LivechatVisitors';\n\nclass LivechatRoomTypeServer extends LivechatRoomType {\n\tgetMsgSender(senderId) {\n\t\treturn LivechatVisitors.findOneById(senderId);\n\t}\n\n\t/**\n\t * Returns details to use on notifications\n\t *\n\t * @param {object} room\n\t * @param {object} user\n\t * @param {string} notificationMessage\n\t * @return {object} Notification details\n\t */\n\tgetNotificationDetails(room, user, notificationMessage) {\n\t\tconst title = `[livechat] ${ this.roomName(room) }`;\n\t\tconst text = notificationMessage;\n\n\t\treturn { title, text };\n\t}\n\n\tcanAccessUploadedFile({ rc_token, rc_rid } = {}) {\n\t\treturn rc_token && rc_rid && RocketChat.models.Rooms.findOneOpenByVisitorToken(rc_token, rc_rid);\n\t}\n}\n\nRocketChat.roomTypes.add(new LivechatRoomTypeServer());\n","/* globals HTTP, SystemLogger */\nimport _ from 'underscore';\n\nlet knowledgeEnabled = false;\nlet apiaiKey = '';\nlet apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id,\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\tAuthorization: `Bearer ${ apiaiKey }`,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date(),\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","import LivechatVisitors from '../../server/models/LivechatVisitors';\n\nfunction validateMessage(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn false;\n\t}\n\n\t// message valid only if it is a livechat room\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn false;\n\t}\n\n\t// if the message hasn't a token, it was NOT sent from the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn false;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\tif (!validateMessage(message, room)) {\n\t\treturn message;\n\t}\n\n\tconst phoneRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_phone_regex'), 'g');\n\tconst msgPhones = message.msg.match(phoneRegexp);\n\n\tconst emailRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_email_regex'), 'gi');\n\tconst msgEmails = message.msg.match(emailRegexp);\n\n\tif (msgEmails || msgPhones) {\n\t\tLivechatVisitors.saveGuestEmailPhoneById(room.v._id, msgEmails, msgPhones);\n\n\t\tRocketChat.callbacks.run('livechat.leadCapture', room);\n\t}\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'leadCapture');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username,\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000,\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email,\n\t\t},\n\t\tmessage: data.message,\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToRDStation(room) {\n\tif (!RocketChat.settings.get('Livechat_RDStation_Token')) {\n\t\treturn room;\n\t}\n\n\tconst livechatData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tif (!livechatData.visitor.email) {\n\t\treturn room;\n\t}\n\n\tconst options = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json',\n\t\t},\n\t\tdata: {\n\t\t\ttoken_rdstation: RocketChat.settings.get('Livechat_RDStation_Token'),\n\t\t\tidentificador: 'rocketchat-livechat',\n\t\t\tclient_id: livechatData.visitor._id,\n\t\t\temail: livechatData.visitor.email,\n\t\t},\n\t};\n\n\toptions.data.nome = livechatData.visitor.name || livechatData.visitor.username;\n\n\tif (livechatData.visitor.phone) {\n\t\toptions.data.telefone = livechatData.visitor.phone;\n\t}\n\n\tif (livechatData.tags) {\n\t\toptions.data.tags = livechatData.tags;\n\t}\n\n\tObject.keys(livechatData.customFields || {}).forEach((field) => {\n\t\toptions.data[field] = livechatData.customFields[field];\n\t});\n\n\tObject.keys(livechatData.visitor.customFields || {}).forEach((field) => {\n\t\toptions.data[field] = livechatData.visitor.customFields[field];\n\t});\n\n\ttry {\n\t\tHTTP.call('POST', 'https://www.rdstation.com.br/api/1.3/conversions', options);\n\t} catch (e) {\n\t\tconsole.error('Error sending lead to RD Station ->', e);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-save-info');\n","const msgNavType = 'livechat_navigation_history';\n\nconst sendMessageType = (msgType) => {\n\tconst sendNavHistory = RocketChat.settings.get('Livechat_Visitor_navigation_as_a_message') && RocketChat.settings.get('Send_visitor_navigation_history_livechat_webhook_request');\n\n\treturn sendNavHistory && msgType === msgNavType;\n};\n\nfunction sendToCRM(type, room, includeMessages = true) {\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tpostData.type = type;\n\n\tpostData.messages = [];\n\n\tlet messages;\n\tif (typeof includeMessages === 'boolean' && includeMessages) {\n\t\tmessages = RocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } });\n\t} else if (includeMessages instanceof Array) {\n\t\tmessages = includeMessages;\n\t}\n\n\tif (messages) {\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.t && !sendMessageType(message.t)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst msg = {\n\t\t\t\t_id: message._id,\n\t\t\t\tusername: message.u.username,\n\t\t\t\tmsg: message.msg,\n\t\t\t\tts: message.ts,\n\t\t\t\teditedAt: message.editedAt,\n\t\t\t};\n\n\t\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\t\tmsg.agentId = message.u._id;\n\t\t\t}\n\n\t\t\tif (message.t === msgNavType) {\n\t\t\t\tmsg.navigation = message.navigation;\n\t\t\t}\n\n\t\t\tpostData.messages.push(msg);\n\t\t});\n\t}\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatSession', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\t// Do not send to CRM if the chat is still open\n\tif (room.open) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatEdit', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// only call webhook if it is a livechat room\n\tif (room.t !== 'l' || room.v == null || room.v.token == null) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor\n\t// if not, it was sent from the agent\n\tif (message.token) {\n\t\tif (!RocketChat.settings.get('Livechat_webhook_on_visitor_message')) {\n\t\t\treturn message;\n\t\t}\n\t} else if (!RocketChat.settings.get('Livechat_webhook_on_agent_message')) {\n\t\treturn message;\n\t}\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\t// unless the settings that handle with visitor navigation history are enabled\n\tif (message.t && !sendMessageType(message.t)) {\n\t\treturn message;\n\t}\n\n\tsendToCRM('Message', room, [message]);\n\treturn message;\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-message');\n\nRocketChat.callbacks.add('livechat.leadCapture', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_capture')) {\n\t\treturn room;\n\t}\n\treturn sendToCRM('LeadCapture', room, false);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-lead-capture');\n","import OmniChannel from '../lib/OmniChannel';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled') || !RocketChat.settings.get('Livechat_Facebook_API_Key')) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.facebook && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tOmniChannel.reply({\n\t\tpage: room.facebook.page.id,\n\t\ttoken: room.v.token,\n\t\ttext: message.msg,\n\t});\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageToFacebook');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:closeByVisitor'({ roomId, token }) {\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorToken(token, roomId);\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst language = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tvisitor,\n\t\t\troom,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language }),\n\t\t});\n\t},\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId || !RocketChat.authz.hasPermission(userId, 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tif (!room || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('room-not-found', 'Room not found', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, user._id, { _id: 1 });\n\t\tif (!subscription && !RocketChat.authz.hasPermission(userId, 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment,\n\t\t});\n\t},\n});\n","import OmniChannel from '../lib/OmniChannel';\n\nMeteor.methods({\n\t'livechat:facebook'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\ttry {\n\t\t\tswitch (options.action) {\n\t\t\t\tcase 'initialState': {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tenabled: RocketChat.settings.get('Livechat_Facebook_Enabled'),\n\t\t\t\t\t\thasToken: !!RocketChat.settings.get('Livechat_Facebook_API_Key'),\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tcase 'enable': {\n\t\t\t\t\tconst result = OmniChannel.enable();\n\n\t\t\t\t\tif (!result.success) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', true);\n\t\t\t\t}\n\n\t\t\t\tcase 'disable': {\n\t\t\t\t\tOmniChannel.disable();\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', false);\n\t\t\t\t}\n\n\t\t\t\tcase 'list-pages': {\n\t\t\t\t\treturn OmniChannel.listPages();\n\t\t\t\t}\n\n\t\t\t\tcase 'subscribe': {\n\t\t\t\t\treturn OmniChannel.subscribe(options.page);\n\t\t\t\t}\n\n\t\t\t\tcase 'unsubscribe': {\n\t\t\t\t\treturn OmniChannel.unsubscribe(options.page);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e.response && e.response.data && e.response.data.error) {\n\t\t\t\tif (e.response.data.error.error) {\n\t\t\t\t\tthrow new Meteor.Error(e.response.data.error.error, e.response.data.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.response) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.response.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.message) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.message);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsole.error('Error contacting omni.rocket.chat:', e);\n\t\t\tthrow new Meteor.Error('integration-error', e.error);\n\t\t}\n\t},\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getAgentData'({ roomId, token }) {\n\t\tcheck(roomId, String);\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t},\n});\n","import _ from 'underscore';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getInitialData'(visitorToken, departmentId) {\n\t\tconst info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\tvisitor: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tallowSwitchingDepartments: null,\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null,\n\t\t\tfileUpload: null,\n\t\t\tconversationFinishedMessage: null,\n\t\t\tnameFieldRegistrationForm: null,\n\t\t\temailFieldRegistrationForm: null,\n\t\t};\n\n\t\tconst options = {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1,\n\t\t\t\tdepartmentId: 1,\n\t\t\t},\n\t\t};\n\t\tconst room = (departmentId) ? RocketChat.models.Rooms.findOpenByVisitorTokenAndDepartmentId(visitorToken, departmentId, options).fetch() : RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, options).fetch();\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t},\n\t\t});\n\n\t\tif (room) {\n\t\t\tinfo.visitor = visitor;\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.fileUpload = initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\t\tinfo.conversationFinishedMessage = initSettings.Livechat_conversation_finished_message;\n\t\tinfo.nameFieldRegistrationForm = initSettings.Livechat_name_field_registration_form;\n\t\tinfo.emailFieldRegistrationForm = initSettings.Livechat_email_field_registration_form;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\t\tinfo.allowSwitchingDepartments = initSettings.Livechat_allow_switching_departments;\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\t\treturn info;\n\t},\n});\n","Meteor.methods({\n\t'livechat:getNextAgent'({ token, department }) {\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(token).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!department) {\n\t\t\tconst requireDeparment = RocketChat.Livechat.getRequiredDepartment();\n\t\t\tif (requireDeparment) {\n\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t}\n\t\t}\n\n\t\tconst agent = RocketChat.Livechat.getNextAgent(department);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(agent.agentId);\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loadHistory'({ token, rid, end, limit = 20, ls }) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.loadMessageHistory({ userId: visitor._id, rid, end, limit, ls });\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn {\n\t\t\t_id: visitor._id,\n\t\t};\n\t},\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, room, pageInfo) {\n\t\tRocketChat.Livechat.savePageHistory(token, room, pageInfo);\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:registerGuest'({ token, name, email, department, customFields } = {}) {\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken,\n\t\t\tname,\n\t\t\temail,\n\t\t\tdepartment,\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.Messages.keepHistoryForToken(token);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\ttoken: 1,\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t},\n\t\t});\n\n\t\t// If it's updating an existing visitor, it must also update the roomInfo\n\t\tconst cursor = RocketChat.models.Rooms.findOpenByVisitorToken(token);\n\t\tcursor.forEach((room) => {\n\t\t\tRocketChat.Livechat.saveRoomInfo(room, visitor);\n\t\t});\n\n\t\tif (customFields && customFields instanceof Array) {\n\t\t\tcustomFields.forEach((customField) => {\n\t\t\t\tif (typeof customField !== 'object') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!customField.scope || customField.scope !== 'room') {\n\t\t\t\t\tconst { key, value, overwrite } = customField;\n\t\t\t\t\tLivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tuserId,\n\t\t\tvisitor,\n\t\t};\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t},\n});\n","Meteor.methods({\n\t'livechat:removeRoom'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'remove-closed-livechat-rooms')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'livechat:removeRoom',\n\t\t\t});\n\t\t}\n\n\t\tif (room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-this-is-not-a-livechat-room', 'This is not a Livechat room', {\n\t\t\t\tmethod: 'livechat:removeRoom',\n\t\t\t});\n\t\t}\n\n\t\tif (room.open) {\n\t\t\tthrow new Meteor.Error('error-room-is-not-closed', 'Room is not closed', {\n\t\t\t\tmethod: 'livechat:removeRoom',\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.models.Messages.removeByRoomId(rid);\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\t\treturn RocketChat.models.Rooms.removeById(rid);\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_show_agent_email',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\t\t];\n\n\t\tconst valid = settings.every((setting) => validSettings.indexOf(setting._id) !== -1);\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo'(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String),\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String),\n\t\t}));\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomData._id, { fields: { t: 1, servedBy: 1 } });\n\n\t\tif (room == null || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tif ((!room.servedBy || room.servedBy._id !== Meteor.userId()) && !RocketChat.authz.hasPermission(Meteor.userId(), 'save-others-livechat-room-info')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t},\n});\n","import s from 'underscore.string';\n\nMeteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values.Livechat_webhookUrl !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values.Livechat_webhookUrl));\n\t\t}\n\n\t\tif (typeof values.Livechat_secret_token !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values.Livechat_secret_token));\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_close !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values.Livechat_webhook_on_close);\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_offline_msg !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values.Livechat_webhook_on_offline_msg);\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_visitor_message !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_visitor_message', !!values.Livechat_webhook_on_visitor_message);\n\t\t}\n\n\t\tif (typeof values.Livechat_webhook_on_agent_message !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_agent_message', !!values.Livechat_webhook_on_agent_message);\n\t\t}\n\n\t\treturn;\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\nimport LivechatVisitors from '../models/LivechatVisitors';\nimport _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && room.v.token === visitor.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array,\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t},\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tsendMessageLivechat({ token, _id, rid, msg, attachments }, agent) {\n\t\tcheck(token, String);\n\t\tcheck(_id, String);\n\t\tcheck(rid, String);\n\t\tcheck(msg, String);\n\n\t\tcheck(agent, Match.Maybe({\n\t\t\tagentId: String,\n\t\t\tusername: String,\n\t\t}));\n\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t\ttoken: 1,\n\t\t\t},\n\t\t});\n\n\t\tif (!guest) {\n\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t}\n\n\t\treturn RocketChat.Livechat.sendMessage({\n\t\t\tguest,\n\t\t\tmessage: {\n\t\t\t\t_id,\n\t\t\t\trid,\n\t\t\t\tmsg,\n\t\t\t\ttoken,\n\t\t\t\tattachments,\n\t\t\t},\n\t\t\tagent,\n\t\t});\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tasync 'sendFileLivechatMessage'(roomId, visitorToken, file, msgData = {}) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\n\t\tif (!visitor) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorToken(visitorToken, roomId);\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String),\n\t\t});\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ encodeURI(file.name) }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true,\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t\tattachment.image_preview = await FileUpload.resizeImagePreview(file);\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type,\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment],\n\t\t\ttoken: visitorToken,\n\t\t}, msgData);\n\n\t\treturn Meteor.call('sendMessageLivechat', msg);\n\t},\n});\n","/* globals DDPRateLimiter */\nimport dns from 'dns';\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String,\n\t\t});\n\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (`${ data.message }`).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${ data.name }</p>\n\t\t\t<p><strong>Visitor email:</strong> ${ data.email }</p>\n\t\t\t<p><strong>Message:</strong><br>${ message }</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${ data.name } - ${ data.email } <${ fromEmail }>`,\n\t\t\t\treplyTo: `${ data.name } <${ data.email }>`,\n\t\t\t\tsubject: `Livechat offline message from ${ data.name }: ${ (`${ data.message }`).substring(0, 20) }`,\n\t\t\t\thtml: header + html + footer,\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t},\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t},\n}, 1, 5000);\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t},\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setDepartmentForVisitor'({ roomId, visitorToken, departmentId } = {}) {\n\t\tcheck(roomId, String);\n\t\tcheck(visitorToken, String);\n\t\tcheck(departmentId, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.Messages.keepHistoryForToken(visitorToken);\n\n\t\tconst transferData = {\n\t\t\troomId,\n\t\t\tdepartmentId,\n\t\t};\n\n\t\treturn RocketChat.Livechat.transfer(room, visitor, transferData);\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date(),\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' },\n\t\t\t],\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + roomId,\n\t\t};\n\t},\n});\n\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:startFileUploadRoom'(roomId, token) {\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date(),\n\t\t\ttoken: guest.token,\n\t\t};\n\n\t\treturn RocketChat.Livechat.getRoom(guest, message);\n\t},\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String),\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, Meteor.userId(), { fields: { _id: 1 } });\n\t\tif (!subscription && !RocketChat.authz.hasRole(Meteor.userId(), 'livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t},\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3',\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456',\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456',\n\t\t\t\t},\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com',\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date(),\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date(),\n\t\t\t}],\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token'),\n\t\t\t},\n\t\t\tdata: sampleData,\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t},\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username,\n\t\t};\n\n\t\t// add subscription\n\t\tconst subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username,\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all',\n\t\t};\n\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\t\tRocketChat.models.Rooms.incUsersCountById(inquiry.rid);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username,\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId),\n\t\t});\n\n\t\t// return inquiry (for redirecting agent to the room route)\n\t\treturn inquiry;\n\t},\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid, departmentId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.returnRoomAsInquiry(rid, departmentId);\n\t},\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t},\n});\n","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nimport moment from 'moment';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:sendTranscript'(token, rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\t\tconst userLanguage = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomIdNotContainingTypes(rid, ['livechat_navigation_history'], { sort: { ts : 1 } });\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tlet html = '<div> <hr>';\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet author;\n\t\t\tif (message.u._id === visitor._id) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tconst datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tconst singleMessage = `\n\t\t\t\t<p><strong>${ author }</strong>  <em>${ datetime }</em></p>\n\t\t\t\t<p>${ message.msg }</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = `${ html }</div>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer,\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t},\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t},\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tconst update = {\n\t\t$set: {\n\t\t\toperator,\n\t\t},\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find an online agent by his username\n * @return\n */\nRocketChat.models.Users.findOneOnlineAgentByUsername = function(username) {\n\tconst query = {\n\t\tusername,\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tconst query = {\n\t\troles: 'livechat-agent',\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList),\n\t\t},\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline',\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t};\n\n\tconst collectionObj = this.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tconst sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1,\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1,\n\t\t},\n\t};\n\n\tconst user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username,\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t_id: userId,\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tstatusLivechat: status,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId,\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\tphone: 1,\n\t\t\tcustomFields: 1,\n\t\t},\n\t};\n\n\tif (RocketChat.settings.get('Livechat_show_agent_email')) {\n\t\toptions.fields.emails = 1;\n\t}\n\n\treturn this.findOne(query, options);\n};\n","import _ from 'underscore';\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id,\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true,\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l',\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset, limit });\n};\n\nRocketChat.models.Rooms.findLivechatById = function(_id, fields) {\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\tconst query = {\n\t\tt: 'l',\n\t\t_id,\n\t};\n\n\treturn this.find(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.updateLivechatRoomCount = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count',\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1,\n\t\t},\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findOpenByVisitorTokenAndDepartmentId = function(visitorToken, departmentId, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken,\n\t\tdepartmentId,\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken,\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId,\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorToken = function(token, roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t\topen: true,\n\t\t'v.token': token,\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId,\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username,\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime,\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1,\n\t\t},\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId,\n\t}, {\n\t\t$set: {\n\t\t\tcloser: closeInfo.closer,\n\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration,\n\t\t\t'v.status': 'offline',\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1,\n\t\t},\n\t});\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId,\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username,\n\t\t\t},\n\t\t},\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.changeDepartmentIdByRoomId = function(roomId, departmentId) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tdepartmentId,\n\t\t},\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateVisitorStatus = function(token, status) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true,\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'v.status': status,\n\t\t},\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.removeAgentByRoomId = function(roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t};\n\tconst update = {\n\t\t$unset: {\n\t\t\tservedBy: 1,\n\t\t},\n\t};\n\n\tthis.update(query, update);\n};\n","RocketChat.models.Messages.keepHistoryForToken = function(token) {\n\treturn this.update({\n\t\t'navigation.token': token,\n\t\texpireAt: {\n\t\t\t$exists: true,\n\t\t},\n\t}, {\n\t\t$unset: {\n\t\t\texpireAt: 1,\n\t\t},\n\t}, {\n\t\tmulti: true,\n\t});\n};\n\nRocketChat.models.Messages.setRoomIdByToken = function(token, rid) {\n\treturn this.update({\n\t\t'navigation.token': token,\n\t\trid: null,\n\t}, {\n\t\t$set: {\n\t\t\trid,\n\t\t},\n\t}, {\n\t\tmulti: true,\n\t});\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","import _ from 'underscore';\n\n/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tconst record = {\n\t\t\tlabel,\n\t\t\tscope,\n\t\t\tvisibility,\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","import _ from 'underscore';\n\n/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1,\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tconst record = {\n\t\t\tenabled,\n\t\t\tname,\n\t\t\tdescription,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration,\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tconst savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tconst agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0,\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tconst query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true,\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","import _ from 'underscore';\n/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order),\n\t\t\t},\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId, agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames,\n\t\t\t},\n\t\t};\n\n\t\tconst sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1,\n\t\t};\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1,\n\t\t\t},\n\t\t};\n\n\t\tconst collectionObj = this.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tconst agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username,\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames,\n\t\t\t},\n\t\t};\n\n\t\tconst depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList,\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1,\n\t\t\t},\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\treplaceUsernameOfAgentByUserId(userId, username) {\n\t\tconst query = { agentId: userId };\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tusername,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update(query, update, { multi: true });\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ token: 1 });\n\t\tthis.tryEnsureIndex({ ts: 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ expireAt: 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tconst keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds,\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true,\n\t\t\t},\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1,\n\t\t\t},\n\t\t}, {\n\t\t\tmulti: true,\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ departmentId: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ rid: 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ name: 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ message: 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ ts: 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ agents: 1 }); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ status: 1 }); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t_id: inquiryId,\n\t\t}, {\n\t\t\t$set: { status: 'taken' },\n\t\t});\n\t}\n\n\t/*\n\t * mark the inquiry as closed\n\t */\n\tcloseByRoomId(roomId, closeInfo) {\n\t\treturn this.update({\n\t\t\trid: roomId,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'closed',\n\t\t\t\tcloser: closeInfo.closer,\n\t\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\t\tchatDuration: closeInfo.chatDuration,\n\t\t\t},\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\treturn this.update({\n\t\t\t_id: inquiryId,\n\t\t}, {\n\t\t\t$set: { status: 'open' },\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open and set agents\n\t */\n\topenInquiryWithAgents(inquiryId, agentIds) {\n\t\treturn this.update({\n\t\t\t_id: inquiryId,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'open',\n\t\t\t\tagents: agentIds,\n\t\t\t},\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId }).status;\n\t}\n\n\tupdateVisitorStatus(token, status) {\n\t\tconst query = {\n\t\t\t'v.token': token,\n\t\t\tstatus: 'open',\n\t\t};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t'v.status': status,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ day: 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ start: 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ finish: 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ open: 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({ day : 'Monday', start : '08:00', finish : '20:00', code : 1, open : true });\n\t\t\tthis.insert({ day : 'Tuesday', start : '08:00', finish : '20:00', code : 2, open : true });\n\t\t\tthis.insert({ day : 'Wednesday', start : '08:00', finish : '20:00', code : 3, open : true });\n\t\t\tthis.insert({ day : 'Thursday', start : '08:00', finish : '20:00', code : 4, open : true });\n\t\t\tthis.insert({ day : 'Friday', start : '08:00', finish : '20:00', code : 5, open : true });\n\t\t\tthis.insert({ day : 'Saturday', start : '08:00', finish : '20:00', code : 6, open : false });\n\t\t\tthis.insert({ day : 'Sunday', start : '08:00', finish : '20:00', code : 0, open : false });\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\tday,\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen,\n\t\t\t},\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({ day: currentTime.format('dddd') });\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tconst result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({ day: currentTime.format('dddd') });\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({ day: currentTime.format('dddd') });\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass LivechatVisitors extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_visitor');\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tgetVisitorByToken(token, options) {\n\t\tconst query = {\n\t\t\ttoken,\n\t\t};\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\t/**\n\t * Find visitors by _id\n\t * @param {string} token - Visitor token\n\t */\n\tfindById(_id, options) {\n\t\tconst query = {\n\t\t\t_id,\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tfindVisitorByToken(token) {\n\t\tconst query = {\n\t\t\ttoken,\n\t\t};\n\n\t\treturn this.find(query);\n\t}\n\n\tupdateLivechatDataByToken(token, key, value, overwrite = true) {\n\t\tconst query = {\n\t\t\ttoken,\n\t\t};\n\n\t\tif (!overwrite) {\n\t\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t[`livechatData.${ key }`]: value,\n\t\t\t},\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n\n\t/**\n\t * Find a visitor by their phone number\n\t * @return {object} User from db\n\t */\n\tfindOneVisitorByPhone(phone) {\n\t\tconst query = {\n\t\t\t'phone.phoneNumber': phone,\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\t/**\n\t * Get the next visitor name\n\t * @return {string} The next visitor name\n\t */\n\tgetNextVisitorUsername() {\n\t\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\t\tconst query = {\n\t\t\t_id: 'Livechat_guest_count',\n\t\t};\n\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tvalue: 1,\n\t\t\t},\n\t\t};\n\n\t\tconst livechatCount = findAndModify(query, null, update);\n\n\t\treturn `guest-${ livechatCount.value.value + 1 }`;\n\t}\n\n\tupdateById(_id, update) {\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsaveGuestById(_id, data) {\n\t\tconst setData = {};\n\t\tconst unsetData = {};\n\n\t\tif (data.name) {\n\t\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\t\tsetData.name = s.trim(data.name);\n\t\t\t} else {\n\t\t\t\tunsetData.name = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.email) {\n\t\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\t\tsetData.visitorEmails = [\n\t\t\t\t\t{ address: s.trim(data.email) },\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.visitorEmails = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.phone) {\n\t\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\t\tsetData.phone = [\n\t\t\t\t\t{ phoneNumber: s.trim(data.phone) },\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.phone = 1;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {};\n\n\t\tif (!_.isEmpty(setData)) {\n\t\t\tupdate.$set = setData;\n\t\t}\n\n\t\tif (!_.isEmpty(unsetData)) {\n\t\t\tupdate.$unset = unsetData;\n\t\t}\n\n\t\tif (_.isEmpty(update)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tfindOneGuestByEmailAddress(emailAddress) {\n\t\tconst query = {\n\t\t\t'visitorEmails.address': new RegExp(`^${ s.escapeRegExp(emailAddress) }$`, 'i'),\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\tsaveGuestEmailPhoneById(_id, emails, phones) {\n\t\tconst update = {\n\t\t\t$addToSet: {},\n\t\t};\n\n\t\tconst saveEmail = [].concat(emails)\n\t\t\t.filter((email) => email && email.trim())\n\t\t\t.map((email) => ({ address: email }));\n\n\t\tif (saveEmail.length > 0) {\n\t\t\tupdate.$addToSet.visitorEmails = { $each: saveEmail };\n\t\t}\n\n\t\tconst savePhone = [].concat(phones)\n\t\t\t.filter((phone) => phone && phone.trim().replace(/[^\\d]/g, ''))\n\t\t\t.map((phone) => ({ phoneNumber: phone }));\n\n\t\tif (savePhone.length > 0) {\n\t\t\tupdate.$addToSet.phone = { $each: savePhone };\n\t\t}\n\n\t\tif (!update.$addToSet.visitorEmails && !update.$addToSet.phone) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n}\n\nexport default new LivechatVisitors();\n","/* globals HTTP */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport UAParser from 'ua-parser-js';\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook',\n\t\t},\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'External') {\n\t\t\tfor (let i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tconst queryString = department ? `?departmentId=${ department }` : '';\n\t\t\t\t\tconst result = HTTP.call('GET', `${ RocketChat.settings.get('Livechat_External_Queue_URL') }${ queryString }`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t\t\tAccept: 'application/json',\n\t\t\t\t\t\t\t'X-RocketChat-Secret-Token': RocketChat.settings.get('Livechat_External_Queue_Token'),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tif (result && result.data && result.data.username) {\n\t\t\t\t\t\tconst agent = RocketChat.models.Users.findOneOnlineAgentByUsername(result.data.username);\n\n\t\t\t\t\t\tif (agent) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\t\t\t\tusername: agent.username,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error('Error requesting agent from external queue.', e);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t} else if (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t}\n\t\treturn RocketChat.models.Users.getNextAgent();\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRequiredDepartment(onlineRequired = true) {\n\t\tconst departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\n\t\treturn departments.fetch().find((dept) => {\n\t\t\tif (!dept.showOnRegistration) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (!onlineRequired) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst onlineAgents = RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(dept._id);\n\t\t\treturn onlineAgents.count() > 0;\n\t\t});\n\t},\n\tgetRoom(guest, message, roomInfo, agent) {\n\t\tlet room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tlet newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!agent && !guest.department) {\n\t\t\t\tconst department = this.getRequiredDepartment();\n\n\t\t\t\tif (department) {\n\t\t\t\t\tguest.department = department._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo, agent);\n\n\t\t\tnewRoom = true;\n\t\t}\n\n\t\tif (!room || room.v.token !== guest.token) {\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\tif (newRoom) {\n\t\t\tRocketChat.models.Messages.setRoomIdByToken(guest.token, room._id);\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo, agent }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom, showConnecting: this.showConnecting() });\n\t},\n\tregisterGuest({ token, name, email, department, phone, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\ttoken,\n\t\t\t},\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = LivechatVisitors.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tlet existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tconst userData = {\n\t\t\t\t\tusername,\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.httpHeaders['x-forwarded-for'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = LivechatVisitors.insert(userData);\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number },\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email },\n\t\t\t];\n\t\t}\n\n\t\tif (name) {\n\t\t\tupdateUser.$set.name = name;\n\t\t}\n\n\t\tif (department) {\n\t\t\tupdateUser.$set.department = department;\n\t\t}\n\n\t\tLivechatVisitors.updateById(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\tsetDepartmentForGuest({ token, department } = {}) {\n\t\tcheck(token, String);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tdepartment,\n\t\t\t},\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\t\tif (user) {\n\t\t\treturn LivechatVisitors.updateById(user._id, updateUser);\n\t\t}\n\t\treturn false;\n\t},\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, visitor, room, comment }) {\n\t\tconst now = new Date();\n\n\t\tconst closeData = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000,\n\t\t};\n\n\t\tif (user) {\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username,\n\t\t\t};\n\t\t} else if (visitor) {\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username,\n\t\t\t};\n\t\t}\n\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, closeData);\n\t\tRocketChat.models.LivechatInquiry.closeByRoomId(room._id, closeData);\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false,\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tif (room.servedBy) {\n\t\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, room.servedBy._id);\n\t\t}\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, closeData.closedBy);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_fileupload_enabled',\n\t\t\t'FileUpload_Enabled',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif ((roomData.topic != null || roomData.tags != null) && !RocketChat.models.Rooms.setTopicAndTagsById(roomData._id, roomData.topic, roomData.tags)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setFnameById(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateDisplayNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment });\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, roomId, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\n\t\t\tconst user = RocketChat.models.Users.findOneById('rocket.cat');\n\n\t\t\tconst pageTitle = pageInfo.title;\n\t\t\tconst pageUrl = pageInfo.location.href;\n\t\t\tconst extraData = {\n\t\t\t\tnavigation: {\n\t\t\t\t\tpage: pageInfo,\n\t\t\t\t\ttoken,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tif (!roomId) {\n\t\t\t\t// keep history of unregistered visitors for 1 month\n\t\t\t\tconst keepHistoryMiliseconds = 2592000000;\n\t\t\t\textraData.expireAt = new Date().getTime() + keepHistoryMiliseconds;\n\t\t\t}\n\n\t\t\tif (!RocketChat.settings.get('Livechat_Visitor_navigation_as_a_message')) {\n\t\t\t\textraData._hidden = true;\n\t\t\t}\n\n\t\t\treturn RocketChat.models.Messages.createNavigationHistoryWithRoomIdMessageAndUser(roomId, `${ pageTitle } - ${ pageUrl }`, user, extraData);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username,\n\t\t\t};\n\t\t} else if (RocketChat.settings.get('Livechat_Routing_Method') !== 'Guest_Pool') {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t} else {\n\t\t\treturn RocketChat.Livechat.returnRoomAsInquiry(room._id, transferData.departmentId);\n\t\t}\n\n\t\tconst { servedBy } = room;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tif (transferData.departmentId) {\n\t\t\t\tRocketChat.models.Rooms.changeDepartmentIdByRoomId(room._id, transferData.departmentId);\n\t\t\t}\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tuserMentions: 1,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username,\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all',\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\t\t\tRocketChat.models.Rooms.incUsersCountById(room._id);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tconst guestData = {\n\t\t\t\ttoken: guest.token,\n\t\t\t\tdepartment: transferData.departmentId,\n\t\t\t};\n\n\t\t\tthis.setDepartmentForGuest(guestData);\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId),\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\treturnRoomAsInquiry(rid, departmentId) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:returnRoomAsInquiry' });\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne(room.servedBy._id);\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:returnRoomAsInquiry' });\n\t\t}\n\n\t\tconst agentIds = [];\n\t\t// get the agents of the department\n\t\tif (departmentId) {\n\t\t\tlet agents = RocketChat.Livechat.getOnlineAgents(departmentId);\n\n\t\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\t\tagents = RocketChat.Livechat.getAgents(departmentId);\n\t\t\t}\n\n\t\t\tif (agents.count() === 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tagents.forEach((agent) => {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t});\n\n\t\t\tRocketChat.models.Rooms.changeDepartmentIdByRoomId(room._id, departmentId);\n\t\t}\n\n\t\t// delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove agent from room\n\t\tRocketChat.models.Rooms.removeAgentByRoomId(rid);\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOne({ rid });\n\t\tif (!inquiry) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet openInq;\n\t\t// mark inquiry as open\n\t\tif (agentIds.length === 0) {\n\t\t\topenInq = RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t\t} else {\n\t\t\topenInq = RocketChat.models.LivechatInquiry.openInquiryWithAgents(inquiry._id, agentIds);\n\t\t}\n\n\t\tif (openInq) {\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(rid, { _id: room.servedBy._id, username: room.servedBy.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(rid, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: null,\n\t\t\t});\n\t\t}\n\n\t\treturn openInq;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token'),\n\t\t\t\t},\n\t\t\t\tdata: postData,\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error(`Response error on ${ trying } try ->`, e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = LivechatVisitors.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy && room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.fname || room.label, // using same field for compatibility\n\t\t\ttopic: room.topic,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (`${ ua.getOS().name } ${ ua.getOS().version }`),\n\t\t\t\tbrowser: ua.getBrowser().name && (`${ ua.getBrowser().name } ${ ua.getBrowser().version }`),\n\t\t\t\tcustomFields: visitor.livechatData,\n\t\t\t},\n\t\t};\n\n\t\tif (agent) {\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null,\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean,\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String,\n\t\t\t}),\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t},\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\n\nRocketChat.Livechat.stream.allowRead((roomId, extraData) => {\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (!room) {\n\t\tconsole.warn(`Invalid eventName: \"${ roomId }\"`);\n\t\treturn false;\n\t}\n\n\tif (room.t === 'l' && extraData && extraData.visitorToken && room.v.token === extraData.visitorToken) {\n\t\treturn true;\n\t}\n\treturn false;\n});\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","import _ from 'underscore';\n\nRocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount'(guest, message, roomInfo, agent) {\n\t\tif (!agent) {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t}\n\n\t\tRocketChat.models.Rooms.updateLivechatRoomCount();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 0,\n\t\t\tusersCount: 1,\n\t\t\tlm: new Date(),\n\t\t\tfname: (roomInfo && roomInfo.fname) || guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online',\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username,\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true,\n\t\t}, roomInfo);\n\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tfname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username,\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all',\n\t\t};\n\n\t\tif (guest.department) {\n\t\t\troom.departmentId = guest.department;\n\t\t}\n\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId),\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool'(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tRocketChat.models.Rooms.updateLivechatRoomCount();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tconst inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online',\n\t\t\t},\n\t\t\tt: 'l',\n\t\t};\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 0,\n\t\t\tusersCount: 0,\n\t\t\tlm: new Date(),\n\t\t\tfname: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status,\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true,\n\t\t}, roomInfo);\n\n\t\tif (guest.department) {\n\t\t\troom.departmentId = guest.department;\n\t\t}\n\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t},\n\t'External'(guest, message, roomInfo, agent) {\n\t\treturn this['Least_Amount'](guest, message, roomInfo, agent); // eslint-disable-line\n\t},\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","const gatewayURL = 'https://omni.rocket.chat';\n\nexport default {\n\tenable() {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json',\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\turl: RocketChat.settings.get('Site_Url'),\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tdisable() {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json',\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tlistPages() {\n\t\tconst result = HTTP.call('GET', `${ gatewayURL }/facebook/pages`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tsubscribe(pageId) {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tunsubscribe(pageId) {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t});\n\t\treturn result.data;\n\t},\n\n\treply({ page, token, text }) {\n\t\treturn HTTP.call('POST', `${ gatewayURL }/facebook/reply`, {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\tpage,\n\t\t\t\ttoken,\n\t\t\t\ttext,\n\t\t\t},\n\t\t});\n\t},\n};\n","import LivechatVisitors from './models/LivechatVisitors';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = LivechatVisitors.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t},\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/* , statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_show_agent_email',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email',\n\t\t\t\t'Livechat_conversation_finished_message',\n\t\t\t\t'Livechat_registration_form',\n\t\t\t\t'Livechat_name_field_registration_form',\n\t\t\t\t'Livechat_email_field_registration_form',\n\t\t\t],\n\t\t},\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t},\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg', 'Livechat_webhook_on_visitor_message', 'Livechat_webhook_on_agent_message']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t},\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date),\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from,\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t},\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t},\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, this.userId, { fields: { _id: 1 } });\n\tif (!subscription) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst self = this;\n\n\tif (room && room.v && room.v._id) {\n\t\tconst handle = RocketChat.models.Rooms.findByVisitorId(room.v._id).observeChanges({\n\t\t\tadded(id, fields) {\n\t\t\t\tself.added('visitor_history', id, fields);\n\t\t\t},\n\t\t\tchanged(id, fields) {\n\t\t\t\tself.changed('visitor_history', id, fields);\n\t\t\t},\n\t\t\tremoved(id) {\n\t\t\t\tself.removed('visitor_history', id);\n\t\t\t},\n\t\t});\n\n\t\tself.ready();\n\n\t\tself.onStop(function() {\n\t\t\thandle.stop();\n\t\t});\n\t} else {\n\t\tself.ready();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn LivechatVisitors.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tconst self = this;\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room) {\n\t\tconst handle = RocketChat.models.Messages.findByRoomIdAndType(room._id, 'livechat_navigation_history').observeChanges({\n\t\t\tadded(id, fields) {\n\t\t\t\tself.added('visitor_navigation_history', id, fields);\n\t\t\t},\n\t\t\tchanged(id, fields) {\n\t\t\t\tself.changed('visitor_navigation_history', id, fields);\n\t\t\t},\n\t\t\tremoved(id) {\n\t\t\t\tself.removed('visitor_navigation_history', id);\n\t\t\t},\n\t\t});\n\n\t\tself.ready();\n\n\t\tself.onStop(function() {\n\t\t\thandle.stop();\n\t\t});\n\t} else {\n\t\tself.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open',\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/facebook.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\nimport '../imports/server/rest/messages.js';\nimport '../imports/server/rest/visitors.js';\nimport '../imports/server/rest/upload.js';\n","import _ from 'underscore';\n\nMeteor.startup(() => {\n\tconst roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('save-others-livechat-room-info', ['livechat-manager']);\n\t\tRocketChat.models.Permissions.createOrUpdate('remove-closed-livechat-rooms', ['livechat-manager', 'admin']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_navigation_history',\n\tsystem: true,\n\tmessage: 'New_visitor_navigation',\n\tdata(message) {\n\t\tif (!message.navigation || !message.navigation.page) {\n\t\t\treturn;\n\t\t}\n\t\treturn {\n\t\t\thistory: `${ (message.navigation.page.title ? `${ message.navigation.page.title } - ` : '') + message.navigation.page.location.href }`,\n\t\t};\n\t},\n});\n\nRocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request',\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/* , params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language }),\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', {\n\t\ttype: 'color',\n\t\teditor: 'color',\n\t\tallowedTypes: ['color', 'expression'],\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t});\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form',\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address',\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title',\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\teditor: 'color',\n\t\tallowedTypes: ['color', 'expression'],\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color',\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message',\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline',\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_allow_switching_departments', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Allow_switching_departments' });\n\tRocketChat.settings.add('Livechat_show_agent_email', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_agent_email' });\n\n\tRocketChat.settings.add('Livechat_conversation_finished_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Conversation_finished_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_preregistration_form',\n\t});\n\n\tRocketChat.settings.add('Livechat_name_field_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_name_field',\n\t});\n\n\tRocketChat.settings.add('Livechat_email_field_registration_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_email_field',\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count',\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' },\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline',\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds',\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL',\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_visitor_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_visitor_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_agent_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_agent_message',\n\t});\n\n\tRocketChat.settings.add('Send_visitor_navigation_history_livechat_webhook_request', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_visitor_navigation_history_on_request',\n\t\ti18nDescription: 'Feature_Depends_on_Livechat_Visitor_navigation_as_a_message_to_be_enabled',\n\t\tenableQuery: { _id: 'Livechat_Visitor_navigation_as_a_message', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_capture', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_lead_capture',\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_email_regex', '\\\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\\\.)+[A-Z]{2,4}\\\\b', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_email_regex',\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_phone_regex', '((?:\\\\([0-9]{1,3}\\\\)|[0-9]{2})[ \\\\-]*?[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$)|[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$))', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_phone_regex',\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled',\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key',\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language',\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' },\n\t\t],\n\t});\n\n\tRocketChat.settings.add('Livechat_Visitor_navigation_as_a_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Send_Visitor_navigation_history_as_a_message',\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled',\n\t});\n\n\tRocketChat.settings.add('Livechat_continuous_sound_notification_new_livechat_room', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Continuous_sound_notifications_for_new_livechat_room',\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_fileupload_enabled', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'FileUpload_Enabled',\n\t\tenableQuery: { _id: 'FileUpload_Enabled', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled',\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true },\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' },\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget',\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours',\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Secret', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours',\n\t});\n\n\tRocketChat.settings.add('Livechat_RDStation_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'RD Station',\n\t\ti18nLabel: 'RDStation_Token',\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\tvalues: [\n\t\t\t{ key: 'External', i18nLabel: 'External_Service' },\n\t\t\t{ key: 'Least_Amount', i18nLabel: 'Least_Amount' },\n\t\t\t{ key: 'Guest_Pool', i18nLabel: 'Guest_Pool' },\n\t\t],\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' },\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Show_queue_list_to_all_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: { $ne: 'External' } },\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_URL', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'External_Queue_Service_URL',\n\t\ti18nDescription: 'For_more_details_please_check_our_docs',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' },\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Secret_token',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' },\n\t});\n});\n","/* globals openRoom, LivechatInquiry */\nimport { RoomSettingsEnum, RoomTypeConfig, RoomTypeRouteConfig, UiTextContext } from 'meteor/rocketchat:lib';\n\nclass LivechatRoomRoute extends RoomTypeRouteConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'live',\n\t\t\tpath: '/live/:id',\n\t\t});\n\t}\n\n\taction(params) {\n\t\topenRoom('l', params.id);\n\t}\n\n\tlink(sub) {\n\t\treturn {\n\t\t\tid: sub.rid,\n\t\t};\n\t}\n}\n\nexport default class LivechatRoomType extends RoomTypeConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tidentifier: 'l',\n\t\t\torder: 5,\n\t\t\ticon: 'livechat',\n\t\t\tlabel: 'Livechat',\n\t\t\troute: new LivechatRoomRoute(),\n\t\t});\n\n\t\tthis.notSubscribedTpl = {\n\t\t\ttemplate: 'livechatNotSubscribed',\n\t\t};\n\t}\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({ _id: identifier });\n\t}\n\n\troomName(roomData) {\n\t\treturn roomData.name || roomData.fname || roomData.label;\n\t}\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t}\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({ _id: roomId }, { fields: { open: 1 } });\n\t\treturn room && room.open === true;\n\t}\n\n\tgetUserStatus(roomId) {\n\t\tconst room = Session.get(`roomData${ roomId }`);\n\t\tif (room) {\n\t\t\treturn room.v && room.v.status;\n\t\t}\n\n\t\tconst inquiry = LivechatInquiry.findOne({ rid: roomId });\n\t\treturn inquiry && inquiry.v && inquiry.v.status;\n\t}\n\n\tallowRoomSettingChange(room, setting) {\n\t\tswitch (setting) {\n\t\t\tcase RoomSettingsEnum.JOIN_CODE:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tgetUiText(context) {\n\t\tswitch (context) {\n\t\t\tcase UiTextContext.HIDE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tcase UiTextContext.LEAVE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tdefault:\n\t\t\t\treturn '';\n\t\t}\n\t}\n}\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch(),\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array,\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch(),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch(),\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array,\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch(),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n","import crypto from 'crypto';\n\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\n\n/**\n * @api {post} /livechat/facebook Send Facebook message\n * @apiName Facebook\n * @apiGroup Livechat\n *\n * @apiParam {String} mid Facebook message id\n * @apiParam {String} page Facebook pages id\n * @apiParam {String} token Facebook user's token\n * @apiParam {String} first_name Facebook user's first name\n * @apiParam {String} last_name Facebook user's last name\n * @apiParam {String} [text] Facebook message text\n * @apiParam {String} [attachments] Facebook message attachments\n */\nRocketChat.API.v1.addRoute('livechat/facebook', {\n\tpost() {\n\t\tif (!this.bodyParams.text && !this.bodyParams.attachments) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!this.request.headers['x-hub-signature']) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled')) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Integration disabled',\n\t\t\t};\n\t\t}\n\n\t\t// validate if request come from omni\n\t\tconst signature = crypto.createHmac('sha1', RocketChat.settings.get('Livechat_Facebook_API_Secret')).update(JSON.stringify(this.request.body)).digest('hex');\n\t\tif (this.request.headers['x-hub-signature'] !== `sha1=${ signature }`) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Invalid signature',\n\t\t\t};\n\t\t}\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: this.bodyParams.mid,\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tfacebook: {\n\t\t\t\t\tpage: this.bodyParams.page,\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(this.bodyParams.token);\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = this.bodyParams.token;\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tname: `${ this.bodyParams.first_name } ${ this.bodyParams.last_name }`,\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = this.bodyParams.text;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tsucess: true,\n\t\t\t\tmessage: RocketChat.Livechat.sendMessage(sendMessage),\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.error('Error using Facebook ->', e);\n\t\t}\n\t},\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/messages', { authRequired: true }, {\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tif (!this.bodyParams.visitor) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor\" is required');\n\t\t}\n\t\tif (!this.bodyParams.visitor.token) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor.token\" is required');\n\t\t}\n\t\tif (!this.bodyParams.messages) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is required');\n\t\t}\n\t\tif (!(this.bodyParams.messages instanceof Array)) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is not an array');\n\t\t}\n\t\tif (this.bodyParams.messages.length === 0) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is empty');\n\t\t}\n\n\t\tconst visitorToken = this.bodyParams.visitor.token;\n\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tlet rid;\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\trid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\trid = Random.id();\n\t\t\t}\n\t\t} else {\n\t\t\trid = Random.id();\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest(this.bodyParams.visitor);\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tconst sentMessages = this.bodyParams.messages.map((message) => {\n\t\t\tconst sendMessage = {\n\t\t\t\tguest: visitor,\n\t\t\t\tmessage: {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid,\n\t\t\t\t\ttoken: visitorToken,\n\t\t\t\t\tmsg: message.msg,\n\t\t\t\t},\n\t\t\t};\n\t\t\tconst sentMessage = RocketChat.Livechat.sendMessage(sendMessage);\n\t\t\treturn {\n\t\t\t\tusername: sentMessage.u.username,\n\t\t\t\tmsg: sentMessage.msg,\n\t\t\t\tts: sentMessage.ts,\n\t\t\t};\n\t\t});\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tmessages: sentMessages,\n\t\t});\n\t},\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tlet visitor = LivechatVisitors.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id(),\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to,\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\tsendMessage.message.attachments = sms.media.map((curr) => {\n\t\t\tconst attachment = {\n\t\t\t\tmessage_link: curr.url,\n\t\t\t};\n\n\t\t\tconst { contentType } = curr;\n\t\t\tswitch (contentType.substr(0, contentType.indexOf('/'))) {\n\t\t\t\tcase 'image':\n\t\t\t\t\tattachment.image_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'video':\n\t\t\t\t\tattachment.video_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'audio':\n\t\t\t\t\tattachment.audio_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn attachment;\n\t\t});\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t},\n});\n","import Busboy from 'busboy';\nimport filesize from 'filesize';\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\nlet maxFileSize;\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\ttry {\n\t\tmaxFileSize = parseInt(value);\n\t} catch (e) {\n\t\tmaxFileSize = RocketChat.models.Settings.findOneById('FileUpload_MaxFileSize').packageValue;\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/upload/:rid', {\n\tpost() {\n\t\tif (!this.request.headers['x-visitor-token']) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst visitorToken = this.request.headers['x-visitor-token'];\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\n\t\tif (!visitor) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorToken(visitorToken, this.urlParams.rid);\n\t\tif (!room) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst busboy = new Busboy({ headers: this.request.headers });\n\t\tconst files = [];\n\t\tconst fields = {};\n\n\t\tMeteor.wrapAsync((callback) => {\n\t\t\tbusboy.on('file', (fieldname, file, filename, encoding, mimetype) => {\n\t\t\t\tif (fieldname !== 'file') {\n\t\t\t\t\treturn files.push(new Meteor.Error('invalid-field'));\n\t\t\t\t}\n\n\t\t\t\tconst fileDate = [];\n\t\t\t\tfile.on('data', (data) => fileDate.push(data));\n\n\t\t\t\tfile.on('end', () => {\n\t\t\t\t\tfiles.push({ fieldname, file, filename, encoding, mimetype, fileBuffer: Buffer.concat(fileDate) });\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tbusboy.on('field', (fieldname, value) => fields[fieldname] = value);\n\n\t\t\tbusboy.on('finish', Meteor.bindEnvironment(() => callback()));\n\n\t\t\tthis.request.pipe(busboy);\n\t\t})();\n\n\t\tif (files.length === 0) {\n\t\t\treturn RocketChat.API.v1.failure('File required');\n\t\t}\n\n\t\tif (files.length > 1) {\n\t\t\treturn RocketChat.API.v1.failure('Just 1 file is allowed');\n\t\t}\n\n\t\tconst file = files[0];\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.mimetype)) {\n\t\t\treturn RocketChat.API.v1.failure({\n\t\t\t\treason: 'error-type-not-allowed',\n\t\t\t});\n\t\t}\n\n\t\t// -1 maxFileSize means there is no limit\n\t\tif (maxFileSize > -1 && file.fileBuffer.length > maxFileSize) {\n\t\t\treturn RocketChat.API.v1.failure({\n\t\t\t\treason: 'error-size-not-allowed',\n\t\t\t\tsizeAllowed: filesize(maxFileSize),\n\t\t\t});\n\t\t}\n\n\t\tconst fileStore = FileUpload.getStore('Uploads');\n\n\t\tconst details = {\n\t\t\tname: file.filename,\n\t\t\tsize: file.fileBuffer.length,\n\t\t\ttype: file.mimetype,\n\t\t\trid: this.urlParams.rid,\n\t\t\tvisitorToken,\n\t\t};\n\n\t\tconst uploadedFile = Meteor.wrapAsync(fileStore.insert.bind(fileStore))(details, file.fileBuffer);\n\n\t\tuploadedFile.description = fields.description;\n\n\t\tdelete fields.description;\n\t\tRocketChat.API.v1.success(Meteor.call('sendFileLivechatMessage', this.urlParams.rid, visitorToken, uploadedFile, fields));\n\t},\n});\n","import _ from 'underscore';\n\nRocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map((user) => _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat')),\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String,\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username'),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null,\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String,\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/visitor/:visitorToken', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(this.urlParams.visitorToken);\n\t\treturn RocketChat.API.v1.success(visitor);\n\t},\n});\n\nRocketChat.API.v1.addRoute('livechat/visitor/:visitorToken/room', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(this.urlParams.visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tservedBy: 1,\n\t\t\t},\n\t\t}).fetch();\n\t\treturn RocketChat.API.v1.success({ rooms });\n\t},\n});\n"]}